<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Order Block Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a202c; /* Tailwind gray-900 */
            color: #e2e8f0; /* Tailwind gray-200 */
            min-height: 100vh; /* Ensure body takes full height */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align to top, not center */
            align-items: center;
        }
        .container {
            max-width: 1200px;
            width: 95%; /* Make it slightly more fluid */
            margin: 20px auto;
            padding: 20px;
            background-color: #2d3748; /* Tailwind gray-800 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .header-area {
            background-color: #2d3748; /* Same as container, ensures no gaps */
            padding-bottom: 1rem; /* Add some padding below title */
        }
        .scan-button {
            background-image: linear-gradient(to right, #6366F1 0%, #8B5CF6 51%, #6366F1 100%);
            transition: 0.5s;
            background-size: 200% auto;
            color: white;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5); /* Purple shadow */
            border-radius: 9999px; /* Full rounded */
            padding: 12px 30px; /* Slightly larger padding */
            font-weight: 700; /* Bolder */
            font-size: 1.25rem; /* text-xl */
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative; /* For ripple effect */
            overflow: hidden; /* For ripple effect */
        }
        .scan-button:hover {
            background-position: right center;
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.8);
            transform: translateY(-2px); /* Subtle lift */
        }
        .scan-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .scan-button .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            animation: ripple-effect 0.6s linear;
            transform: scale(0);
            opacity: 1;
        }
        @keyframes ripple-effect {
            to {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        .filter-button, .timeframe-button, .sensitivity-button, .chart-button, .auth-button, .payment-button {
            background-color: #4A5568; /* Gray-700 */
            color: white;
            padding: 10px 20px; /* Slightly larger padding */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* Bolder */
            cursor: pointer;
            border: 1px solid #6B7280; /* Gray-500 */
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Subtle shadow */
        }
        .filter-button:hover:not(:disabled), .timeframe-button:hover:not(:disabled), .sensitivity-button:hover:not(:disabled), .chart-button:hover:not(:disabled), .auth-button:hover:not(:disabled), .payment-button:hover:not(:disabled) {
            background-color: #6B7280; /* Gray-500 */
            border-color: #9CA3AF; /* Gray-400 */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); /* More pronounced shadow on hover */
        }
        .filter-button.active, .timeframe-button.active, .sensitivity-button.active, .auth-button.active {
            background-color: #4299E1; /* Blue-500 */
            border-color: #2B6CB0; /* Blue-700 */
            font-weight: 700;
            box-shadow: 0 0 10px rgba(66, 153, 225, 0.5); /* Blue glow */
        }
        .filter-button:disabled, .timeframe-button:disabled, .sensitivity-button:disabled, .chart-button:disabled, .auth-button:disabled, .payment-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        .coin-card {
            background-color: #2D3748; /* Darker slate */
            border-left: 5px solid; /* Thicker border */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25); /* More pronounced shadow */
            padding: 1.5rem; /* p-6 */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer; /* Indicate clickable */
            position: relative; /* For potential future enhancements */
            overflow: hidden; /* Ensure content stays within rounded corners */
        }
        .coin-card:hover {
            transform: translateY(-8px); /* More pronounced lift */
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4); /* Deeper shadow on hover */
        }
        .buying-ob-border {
            border-left-color: #10B981; /* Green */
        }
        .selling-ob-border {
            border-left-color: #EF4444; /* Red */
        }
        .no-ob-border {
            border-left-color: #6B7280; /* Gray */
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styles for the parameter sections */
        .parameters-section {
            background-color: #2D3748; /* Darker slate */
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        .parameters-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
        }
        .param-input-group { /* Keep this style for priceDeviation, but removed for others */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .param-input-group label {
            font-weight: 600;
            color: #9CA3AF; /* gray-400 */
        }
        .param-input-group input[type="number"],
        .param-input-group input[type="text"],
        .param-input-group input[type="email"],
        .param-input-group input[type="password"] {
            width: 100%; /* Make text inputs full width within their group */
            max-width: 250px; /* Limit max width for forms */
            padding: 0.6rem 0.85rem; /* Slightly more padding */
            border-radius: 0.375rem; /* rounded-md */
            background-color: #4A5568; /* gray-700 */
            color: #E2E8F0; /* gray-200 */
            border: 1px solid #6B7280; /* gray-600 */
            text-align: left; /* Align text left for forms */
            font-size: 0.9rem; /* Slightly larger font */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .param-input-group input[type="number"]:focus,
        .param-input-group input[type="text"]:focus,
        .param-input-group input[type="email"]:focus,
        .param-input-group input[type="password"]:focus {
            outline: none;
            border-color: #4299E1; /* blue-500 */
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); /* blue-500 with opacity, thicker glow */
        }


        /* Modal Styles */
        .modal {
          position: fixed;
          z-index: 100; /* High z-index to be on top */
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto; /* Enable scroll if content is too tall */
          background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 20px; /* Add some padding around the modal content */
        }
        .modal-content {
          background-color: #2d3748; /* Tailwind gray-800 */
          margin: auto;
          padding: 20px;
          border-radius: 0.75rem;
          box-shadow: 0 10px 20px rgba(0,0,0,0.5);
          width: 90%; /* Responsive width */
          max-width: 1000px; /* Max width for larger screens */
          position: relative;
          display: flex;
          flex-direction: column;
          gap: 15px;
        }
        .close-button {
          color: #aaa;
          position: absolute;
          top: 10px;
          right: 20px;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
          color: white;
          text-decoration: none;
          cursor: pointer;
        }
        .tradingview-widget-container {
            height: 80vh; /* Use viewport height for responsiveness */
            max-height: 700px; /* Max height for larger screens */
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden; /* Ensure rounded corners on widget */
        }
        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            .tradingview-widget-container {
                height: 60vh; /* Smaller height on mobile */
                max-height: 400px; /* Adjust max height for mobile */
            }
        }
        /* Payment Modal Specific Styles */
        #paymentModal .modal-content {
            max-width: 500px; /* Smaller modal for payment */
            text-align: center;
        }
        #paymentModal .payment-info {
            background-color: #1a202c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        /* Admin Panel Styles */
        #adminPanel {
            background-color: #2D3748;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem;
        }
        .user-table-header th {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #4A5568;
            color: #A0AEC0;
        }
        .user-table-row td {
            padding: 0.75rem;
            text-align: left; /* Ensure text aligns left */
            border-bottom: 1px solid #2D3748;
        }
        .user-table-row:last-child td {
            border-bottom: none;
        }
        .user-table-row button {
            margin-right: 0.5rem;
        }

        /* New styles for Premium Welcome Modal */
        #premiumWelcomeModal .modal-content {
            max-width: 600px;
            text-align: center;
        }
        #premiumWelcomeModal ul {
            list-style: none;
            padding: 0;
            margin-top: 1rem;
            text-align: left;
            color: #A0AEC0; /* gray-400 */
        }
        #premiumWelcomeModal ul li {
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #premiumWelcomeModal ul li svg {
            color: #48BB78; /* Green checkmark */
            flex-shrink: 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
<div class="container">
    <div class="header-area">
        <h1 class="text-4xl font-bold text-center text-blue-400 mb-6">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                        Crypto Order Block Scanner
                    </span>
        </h1>

        <p class="text-center text-gray-400 mb-8">
            Unlock powerful insights into market order blocks.
        </p>
    </div>

    <!-- Authentication Section (Initially visible) -->
    <div id="authSection" class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8 max-w-md mx-auto">
        <h2 id="authFormTitle" class="text-2xl font-bold text-blue-300 text-center mb-4">Login</h2>
        <form id="authForm" class="flex flex-col gap-4">
            <div class="param-input-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required class="w-full">
            </div>
            <div class="param-input-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required class="w-full">
            </div>
            <div id="emailGroup" class="param-input-group hidden">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" class="w-full">
            </div>
            <div id="planGroup" class="param-input-group hidden">
                <label for="plan">Plan:</label>
                <select id="plan" name="plan" class="w-full px-3 py-2 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="trial">3-Day Trial</option>
                    <option value="premium">Premium</option>
                </select>
            </div>
            <button type="submit" id="authSubmitButton" class="scan-button w-full">Login</button>
        </form>
        <p class="text-center mt-4">
            <button id="toggleAuthMode" class="text-blue-400 hover:underline">Don't have an account? Register here.</button>
        </p>
        <p id="authMessage" class="text-center text-red-400 mt-4"></p>
        <!-- Temporary Admin Registration Button removed for security -->
    </div>

    <!-- Scanner Section (Initially hidden) -->
    <div id="scannerSection" class="hidden">
        <div class="flex justify-between items-center mb-4">
            <div class="flex flex-col md:flex-row justify-center items-center gap-4">
                <button id="scanButton" class="scan-button">
                    <span id="spinner" class="spinner hidden"></span>
                    <span id="buttonText">Initiate Scan</span>
                </button>
                <button id="clearButton" class="filter-button">Clear Results</button>
            </div>
            <button id="logoutButton" class="auth-button bg-red-600 hover:bg-red-700">Logout</button>
        </div>


        <div class="flex justify-center gap-3 mb-6 flex-wrap">
            <span class="text-gray-300 font-semibold self-center">Timeframe:</span>
            <button id="timeframe1hButton" class="timeframe-button" data-timeframe="1h">1H</button>
            <button id="timeframe4hButton" class="timeframe-button active" data-timeframe="4h">4H</button>
            <button id="timeframe1dButton" class="timeframe-button" data-timeframe="1d">1D</button>
        </div>

        <div class="flex justify-center gap-3 mb-6 flex-wrap">
            <span class="text-gray-300 font-semibold self-center">Filter:</span>
            <button id="showAllButton" class="filter-button active" data-filter="All">Show All</button>
            <button id="showBuyingButton" class="filter-button" data-filter="Buying (Bullish)">Show Buying OB</button>
            <button id="showSellingButton" class="filter-button" data-filter="Selling (Bearish)">Show Selling OB</button>
        </div>

        <!-- New section for Order Block Detection Parameters and Price Deviation -->
        <div class="parameters-section">
            <h2 class="text-2xl font-bold text-blue-300 text-center mb-4">Detection Sensitivity</h2>
            <div class="parameters-grid mb-4">
                <button class="sensitivity-button" data-sensitivity="lowest">Lowest Condition</button>
                <button class="sensitivity-button" data-sensitivity="low-mid">Low Mid</button>
                <button class="sensitivity-button active" data-sensitivity="mid">Mid</button>
                <button class="sensitivity-button" data-sensitivity="mid-high">Mid High</button>
                <button class="sensitivity-button" data-sensitivity="high">High</button>
                <button class="sensitivity-button" data-sensitivity="extreme">Extreme Detection</button>
            </div>

            <div class="flex flex-col sm:flex-row items-center justify-center gap-3 mt-4">
                <label for="priceDeviation" class="text-gray-300 font-semibold">Max Price Deviation (%):</label>
                <input type="number" id="priceDeviation" value="20" min="0" max="100" class="w-24 px-3 py-2 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>


        <p id="statusMessage" class="text-center text-gray-300 italic mb-6">Click "Initiate Scan" to begin analyzing market data.</p>
        <p id="errorMessage" class="text-center text-red-500 font-bold mb-6"></p>

        <div id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Scan results will be injected here -->
        </div>

        <!-- NEW: Admin Panel Button -->
        <div class="text-center mt-8">
            <button id="adminPanelButton" class="auth-button hidden">User Management (Admin)</button>
        </div>
    </div>
</div>

<!-- Chart Modal Structure -->
<div id="chartModal" class="modal hidden">
    <div class="modal-content">
        <span class="close-button" id="closeModal">&times;</span>
        <h3 id="modalTitle" class="text-2xl font-bold text-blue-300 text-center mb-4"></h3>
        <p id="modalOBInfo" class="text-center text-gray-300 mb-4"></p>
        <div class="tradingview-widget-container">
            <div id="tradingview_chart"></div>
        </div>
        <a id="tradingViewLink" href="#" target="_blank" class="chart-button inline-block text-center px-4 py-2 rounded-lg font-semibold text-sm self-center">
            View on TradingView.com for Drawing
        </a>
    </div>
</div>

<!-- Payment Modal Structure -->
<div id="paymentModal" class="modal hidden">
    <div class="modal-content">
        <span class="close-button" id="closePaymentModal">&times;</span>
        <h3 class="text-2xl font-bold text-blue-300 text-center mb-4">Premium Plan Payment</h3>
        <p class="text-gray-300 mb-4">
            To activate your Premium plan, please send payment to the address below.
            After payment, submit your transaction hash.
        </p>
        <div class="payment-info p-4 rounded-md bg-gray-700 text-gray-200 mb-4">
            <p class="font-semibold">Payment Address (USDT TRC20):</p>
            <p class="break-all text-green-400 text-lg font-mono">TLP9p4PqF4Y9p4PqF4Y9p4PqF4Y9p4PqF4Y9p4PqF4Y</p> <!-- REPLACE WITH YOUR ACTUAL ADDRESS -->
            <p class="mt-2 font-semibold">Amount: $50 USD</p>
        </div>
        <form id="paymentProofForm" class="flex flex-col gap-4">
            <div class="param-input-group">
                <label for="transactionHash">Transaction Hash (TxID):</label>
                <input type="text" id="transactionHash" name="transactionHash" required class="w-full">
            </div>
            <button type="submit" id="submitPaymentProofButton" class="payment-button w-full">Submit Payment Proof</button>
        </form>
        <p id="paymentMessage" class="text-center text-red-400 mt-4"></p>
    </div>
</div>

<!-- Admin Panel Modal Structure -->
<div id="adminPanelModal" class="modal hidden">
    <div class="modal-content max-w-4xl">
        <span class="close-button" id="closeAdminPanelModal">&times;</span>
        <h3 class="text-2xl font-bold text-blue-300 text-center mb-4">User Management Panel</h3>
        <p id="adminMessage" class="text-center text-red-400 mb-4"></p>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-gray-700 rounded-lg">
                <thead>
                <tr class="user-table-header">
                    <th>Username</th>
                    <th>Email</th>
                    <th>Premium</th>
                    <th>Trial Active</th>
                    <th>Trial Expiry</th>
                    <th>Roles</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="userTableBody">
                <!-- User data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Premium Welcome Modal -->
<div id="premiumWelcomeModal" class="modal hidden">
    <div class="modal-content">
        <span class="close-button" id="closePremiumWelcomeModal">&times;</span>
        <h3 class="text-3xl font-bold text-blue-300 text-center mb-4">Welcome to Premium!</h3>
        <p class="text-gray-300 mb-4">
            Congratulations on unlocking the full power of the Crypto Order Block Scanner!
            Here's what you can now do:
        </p>
        <ul class="text-lg text-gray-200 mb-6">
            <li><svg class="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                **All Timeframes Unlocked:** Scan for Order Blocks on 1H, 4H, and 1D charts for deeper market analysis.
            </li>
            <li><svg class="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                **Full Sensitivity Control:** Utilize all 6 detection sensitivity levels (Lowest to Extreme) to fine-tune your scans.
            </li>
            <li><svg class="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                **Advanced Charting:** Click on any coin card to view its Order Block directly on a TradingView chart.
            </li>
            <li><svg class="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                **Admin Panel Access (for Admins):** Manage users and their premium/trial statuses (if you have admin privileges).
            </li>
        </ul>
        <p class="text-gray-400 text-sm mt-4">
            You can always review these features by re-logging in or refreshing the page.
        </p>
        <div class="flex items-center justify-center mt-6">
            <input type="checkbox" id="dontShowPremiumAgain" class="mr-2 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
            <label for="dontShowPremiumAgain" class="text-gray-400">Don't show this again</label>
        </div>
        <button id="closePremiumWelcomeModalButton" class="scan-button mt-6 w-full max-w-xs mx-auto">Got It!</button>
    </div>
</div>


<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.umd.js"></script>
<script>
    // --- Configuration ---
    // IMPORTANT: Replace with your actual OCI VM Public IP or domain name after setting up HTTPS!
    const API_BASE_URL = "http://213.35.118.31:8080/api";

    // --- DOM Elements (Authentication) ---
    const authSection = document.getElementById('authSection');
    const scannerSection = document.getElementById('scannerSection');
    const authForm = document.getElementById('authForm');
    const authFormTitle = document.getElementById('authFormTitle');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const emailGroup = document.getElementById('emailGroup');
    const emailInput = document.getElementById('email');
    const planGroup = document.getElementById('planGroup');
    const planSelect = document.getElementById('plan');
    const authSubmitButton = document.getElementById('authSubmitButton');
    const toggleAuthModeButton = document.getElementById('toggleAuthMode');
    const authMessage = document.getElementById('authMessage');
    const logoutButton = document.getElementById('logoutButton');
    // const registerAdminButton = document.getElementById('registerAdminButton'); // Removed for security

    // --- DOM Elements (Scanner - existing) ---
    const scanButton = document.getElementById('scanButton');
    const clearButton = document.getElementById('clearButton');
    const showAllButton = document.getElementById('showAllButton');
    const showBuyingButton = document.getElementById('showBuyingButton');
    const showSellingButton = document.getElementById('showSellingButton');
    const timeframe1hButton = document.getElementById('timeframe1hButton');
    const timeframe4hButton = document.getElementById('timeframe4hButton');
    const timeframe1dButton = document.getElementById('timeframe1dButton');
    const spinner = document.getElementById('spinner');
    const buttonText = document.getElementById('buttonText');
    const statusMessage = document.getElementById('statusMessage');
    const errorMessage = document.getElementById('errorMessage');
    const resultsContainer = document.getElementById('resultsContainer');
    const sensitivityButtons = document.querySelectorAll('.sensitivity-button');
    const priceDeviationInput = document.getElementById('priceDeviation');

    // Modal elements
    const chartModal = document.getElementById('chartModal');
    const closeModalButton = document.getElementById('closeModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalOBInfo = document.getElementById('modalOBInfo');
    const tradingViewLink = document.getElementById('tradingViewLink');

    // Payment Modal elements
    const paymentModal = document.getElementById('paymentModal');
    const closePaymentModalButton = document.getElementById('closePaymentModal');
    const paymentProofForm = document.getElementById('paymentProofForm');
    const transactionHashInput = document.getElementById('transactionHash');
    const submitPaymentProofButton = document.getElementById('submitPaymentProofButton');
    const paymentMessage = document.getElementById('paymentMessage');

    // Admin Panel elements (NEW)
    const adminPanelButton = document.getElementById('adminPanelButton');
    const adminPanelModal = document.getElementById('adminPanelModal');
    const closeAdminPanelModalButton = document.getElementById('closeAdminPanelModal');
    const userTableBody = document.getElementById('userTableBody');
    const adminMessage = document.getElementById('adminMessage');

    // Premium Welcome Modal elements (NEW)
    const premiumWelcomeModal = document.getElementById('premiumWelcomeModal');
    const closePremiumWelcomeModalButton = document.getElementById('closePremiumWelcomeModalButton');
    const closePremiumWelcomeModalX = document.getElementById('closePremiumWelcomeModal');
    const dontShowPremiumAgainCheckbox = document.getElementById('dontShowPremiumAgain');


    let allScanResults = [];
    let currentFilter = 'All';
    let currentTimeframe = '4h';
    let currentSensitivity = 'mid'; // Default sensitivity
    let maxPriceDeviationPercent = 20; // Default max price deviation
    let isRegisterMode = false; // State for auth form
    let isAdminRegisterMode = false; // Flag for admin registration mode (logic removed for security)

    // Predefined parameter presets for different sensitivities
    const sensitivityPresets = {
      'lowest': { minBodyRatio: 0.001, minPriceChange: 0.000001, volumeFactor: 0.01, requireBOS: false, requireC3ClosePastC2: false, requireFVG: false, requireUnmitigated: false, minFvgDepthRatio: 0.001 }, // Relaxed for lowest
      'low-mid': { minBodyRatio: 0.10, minPriceChange: 0.0003, volumeFactor: 0.4, requireBOS: true, requireC3ClosePastC2: true, requireFVG: true, requireUnmitigated: true, minFvgDepthRatio: 0.02 },
      'mid': { minBodyRatio: 0.15, minPriceChange: 0.0005, volumeFactor: 0.6, requireBOS: true, requireC3ClosePastC2: true, requireFVG: true, requireUnmitigated: true, minFvgDepthRatio: 0.05 },
      'mid-high': { minBodyRatio: 0.20, minPriceChange: 0.001, volumeFactor: 0.8, requireBOS: true, requireC3ClosePastC2: true, requireFVG: true, requireUnmitigated: true, minFvgDepthRatio: 0.08 },
      'high': { minBodyRatio: 0.25, minPriceChange: 0.002, volumeFactor: 1.0, requireBOS: true, requireC3ClosePastC2: true, requireFVG: true, requireUnmitigated: true, minFvgDepthRatio: 0.10 },
      'extreme': { minBodyRatio: 0.30, minPriceChange: 0.003, volumeFactor: 1.2, requireBOS: true, requireC3ClosePastC2: true, requireFVG: true, requireUnmitigated: true, minFvgDepthRatio: 0.15 }
    };


    // --- Authentication Functions ---

    function showAuthSection() {
        authSection.classList.remove('hidden');
        scannerSection.classList.add('hidden');
        paymentModal.classList.add('hidden');
        adminPanelModal.classList.add('hidden'); // Ensure admin modal is hidden
        premiumWelcomeModal.classList.add('hidden'); // Ensure premium welcome modal is hidden
        authMessage.textContent = '';
        usernameInput.value = '';
        passwordInput.value = '';
        emailInput.value = '';
        localStorage.removeItem('jwtToken');
        localStorage.removeItem('username');
        localStorage.removeItem('roles');
        localStorage.removeItem('userId');
        adminPanelButton.classList.add('hidden'); // Hide admin button on logout
        // Reset auth form to login mode
        isRegisterMode = false;
        isAdminRegisterMode = false; // Reset admin register mode flag
        authFormTitle.textContent = 'Login';
        authSubmitButton.textContent = 'Login';
        emailGroup.classList.add('hidden');
        planGroup.classList.add('hidden');
        toggleAuthModeButton.textContent = "Don't have an account? Register here.";
        // registerAdminButton.classList.remove('hidden'); // Admin registration button removed permanently
    }

    async function showScannerSection() {
        authSection.classList.add('hidden');
        paymentModal.classList.add('hidden');
        adminPanelModal.classList.add('hidden'); // Ensure admin modal is hidden
        premiumWelcomeModal.classList.add('hidden'); // Ensure premium welcome modal is hidden
        scannerSection.classList.remove('hidden');
        statusMessage.textContent = `Welcome, ${localStorage.getItem('username')}! Click "Initiate Scan" to begin analyzing market data.`;
        errorMessage.textContent = '';
        await fetchUserStatus(); // Fetch status to update UI and admin button visibility

        // Show premium welcome modal if user is premium/trial and hasn't seen it
        const userRoles = localStorage.getItem('roles') ? JSON.parse(localStorage.getItem('roles')) : [];
        const isPremiumOrTrial = userRoles.includes('ROLE_PREMIUM') || userRoles.includes('ROLE_TRIAL');
        const hasSeenPremiumWelcome = localStorage.getItem('hasSeenPremiumWelcome');

        if (isPremiumOrTrial && hasSeenPremiumWelcome !== 'true') {
            showPremiumWelcomeModal();
        }
    }

    function showPaymentSection(registeredUsername) {
        authSection.classList.add('hidden');
        scannerSection.classList.add('hidden');
        adminPanelModal.classList.add('hidden'); // Ensure admin modal is hidden
        premiumWelcomeModal.classList.add('hidden'); // Ensure premium welcome modal is hidden
        paymentModal.classList.remove('hidden');
        paymentMessage.textContent = '';
        transactionHashInput.value = '';
        localStorage.setItem('pendingPaymentUsername', registeredUsername);
    }

    // Show Premium Welcome Modal
    function showPremiumWelcomeModal() {
        premiumWelcomeModal.classList.remove('hidden');
    }

    function closePremiumWelcomeModal() {
        premiumWelcomeModal.classList.add('hidden');
        if (dontShowPremiumAgainCheckbox.checked) {
            localStorage.setItem('hasSeenPremiumWelcome', 'true');
        }
    }


    async function showAdminPanel() {
        adminPanelModal.classList.remove('hidden');
        adminMessage.textContent = 'Loading users...';
        userTableBody.innerHTML = ''; // Clear previous users

        const token = localStorage.getItem('jwtToken');
        if (!token) {
            adminMessage.textContent = "Authentication required for admin panel.";
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/admin/users`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                adminMessage.style.color = '#EF4444';
                adminMessage.textContent = errorData.message || "Failed to fetch users.";
                return;
            }

            const users = await response.json();
            displayUsersInAdminPanel(users);
            adminMessage.textContent = ''; // Clear message on success

        } catch (error) {
            adminMessage.style.color = '#EF4444';
            adminMessage.textContent = `Network error fetching users: ${error.message}`;
            console.error("Admin panel fetch error:", error);
        }
    }

    // Display users in admin panel table
    function displayUsersInAdminPanel(users) {
        userTableBody.innerHTML = '';
        if (users.length === 0) {
            userTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No users found.</td></tr>';
            return;
        }

        users.forEach(user => {
            const isPremium = user.isPremium ? 'Yes' : 'No';
            const trialActive = user.trialActive ? 'Yes' : 'No';
            const trialExpiry = user.trialExpiryDate ? new Date(user.trialExpiryDate).toLocaleDateString() : 'N/A';
            const roles = user.roles ? user.roles.join(', ') : 'N/A';

            userTableBody.innerHTML += `
                <tr class="user-table-row border-b border-gray-600 last:border-b-0">
                    <td class="py-2 px-4">${user.username}</td>
                    <td class="py-2 px-4">${user.email}</td>
                    <td class="py-2 px-4">${isPremium}</td>
                    <td class="py-2 px-4">${trialActive}</td>
                    <td class="py-2 px-4">${trialExpiry}</td>
                    <td class="py-2 px-4 text-sm text-gray-400">${roles}</td>
                    <td class="py-2 px-4">
                        <button class="auth-button bg-green-600 hover:bg-green-700 grant-premium-btn" data-username="${user.username}" ${user.isPremium ? 'disabled' : ''}>Grant Premium</button>
                        <button class="auth-button bg-red-600 hover:bg-red-700 revoke-premium-btn" data-username="${user.username}" ${!user.isPremium ? 'disabled' : ''}>Revoke Premium</button>
                        <button class="auth-button bg-blue-600 hover:bg-blue-700 activate-trial-btn" data-username="${user.username}" ${user.trialActive ? 'disabled' : ''}>Activate 3-Day Trial</button>
                    </td>
                </tr>
            `;
        });

        // Add event listeners to the action buttons
        document.querySelectorAll('.grant-premium-btn').forEach(button => {
            button.addEventListener('click', (e) => grantPremium(e.target.dataset.username));
        });
        document.querySelectorAll('.revoke-premium-btn').forEach(button => {
            button.addEventListener('click', (e) => revokePremium(e.target.dataset.username));
        });
        document.querySelectorAll('.activate-trial-btn').forEach(button => {
            button.addEventListener('click', (e) => activateTrial(e.target.dataset.username));
        });
    }

    // Admin Actions
    async function grantPremium(username) {
        adminMessage.textContent = 'Granting premium...';
        const token = localStorage.getItem('jwtToken');
        try {
            const response = await fetch(`${API_BASE_URL}/admin/grant-premium/${username}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.ok) {
                adminMessage.style.color = '#48BB78';
                adminMessage.textContent = data.message;
                showAdminPanel(); // Refresh user list
            } else {
                adminMessage.style.color = '#EF4444';
                adminMessage.textContent = data.message || `Failed to grant premium to ${username}.`;
            }
        } catch (error) {
            adminMessage.style.color = '#EF4444';
            adminMessage.textContent = `Network error: ${error.message}`;
        }
    }

    async function revokePremium(username) {
        adminMessage.textContent = 'Revoking premium...';
        const token = localStorage.getItem('jwtToken');
        try {
            const response = await fetch(`${API_BASE_URL}/admin/revoke-premium/${username}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.ok) {
                adminMessage.style.color = '#48BB78';
                adminMessage.textContent = data.message;
                showAdminPanel(); // Refresh user list
            } else {
                adminMessage.style.color = '#EF4444';
                adminMessage.textContent = data.message || `Failed to revoke premium from ${username}.`;
            }
        } catch (error) {
            adminMessage.style.color = '#EF4444';
            adminMessage.textContent = `Network error: ${error.message}`;
        }
        }

    async function activateTrial(username) {
        adminMessage.textContent = 'Activating trial...';
        const token = localStorage.getItem('jwtToken');
        try {
            const response = await fetch(`${API_BASE_URL}/admin/activate-trial/${username}/3`, { // 3 days for trial
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.ok) {
                adminMessage.style.color = '#48BB78';
                adminMessage.textContent = data.message;
                showAdminPanel(); // Refresh user list
            } else {
                adminMessage.style.color = '#EF4444';
                adminMessage.textContent = data.message || `Failed to activate trial for ${username}.`;
            }
        } catch (error) {
            adminMessage.style.color = '#EF4444';
            adminMessage.textContent = `Network error: ${error.message}`;
        }
    }


    async function fetchUserStatus() {
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            console.log("No token found, cannot fetch user status.");
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/user/status`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("Failed to fetch user status:", errorData.message);
                if (response.status === 401 || response.status === 403) {
                    showAuthSection();
                    authMessage.textContent = "Session expired or invalid. Please log in again.";
                }
                return;
            }

            const userData = await response.json();
            console.log("User status:", userData);

            // Check for admin role and show/hide admin button
            const userRoles = localStorage.getItem('roles') ? JSON.parse(localStorage.getItem('roles')) : [];
            if (userRoles.includes('ROLE_ADMIN')) {
                adminPanelButton.classList.remove('hidden');
            } else {
                adminPanelButton.classList.add('hidden');
            }

            if (!userData.isPremium && !userData.trialActive) {
                timeframe1hButton.disabled = true;
                timeframe1dButton.disabled = true;
                if (currentTimeframe !== '4h') {
                    setTimeframe('4h');
                }
                statusMessage.textContent = `Welcome, ${userData.username}! Your trial has expired or you are not premium. Only 4H scans available.`;
            } else if (userData.trialActive) {
                 statusMessage.textContent = `Welcome, ${userData.username}! Your trial expires on ${new Date(userData.trialExpiryDate).toLocaleDateString()}.`;
                 timeframe1hButton.disabled = false;
                 timeframe1dButton.disabled = false;
            } else if (userData.isPremium) {
                 statusMessage.textContent = `Welcome, ${userData.username}! You have premium access.`;
                 timeframe1hButton.disabled = false;
                 timeframe1dButton.disabled = false;
            }


        } catch (error) {
            console.error("Error fetching user status:", error);
            authMessage.textContent = "Error connecting to the service. Please try again."; // Generic error message
        }
    }


    async function handleAuthSubmit(event) {
        event.preventDefault();
        authMessage.textContent = '';
        authSubmitButton.disabled = true;

        const username = usernameInput.value;
        const password = passwordInput.value;
        const email = emailInput.value;
        const plan = planSelect.value;

        let endpoint = `${API_BASE_URL}/auth/login`; // Default to login endpoint
        let body = { username, password };

        if (isAdminRegisterMode) { // If in admin registration mode (logic removed for security)
            // This block should ideally not be reachable if the button is removed
            // but keeping the structure for robustness.
            endpoint = `${API_BASE_URL}/auth/register-admin`;
            body = { username, password, email };
            if (!username || !password || !email) {
                authMessage.style.color = '#EF4444';
                authMessage.textContent = "Username, password, and email are required for admin registration.";
                authSubmitButton.disabled = false;
                return;
            }
        } else if (isRegisterMode) { // If in regular user registration mode
            endpoint = `${API_BASE_URL}/auth/register`;
            body.email = email;
            body.plan = plan;
            // Validate inputs for regular registration
            if (!username || !password || !email) {
                authMessage.style.color = '#EF4444';
                authMessage.textContent = "Username, password, and email are required for registration.";
                authSubmitButton.disabled = false;
                return;
            }
        } else { // Login mode
            // Validate inputs for login
            if (!username || !password) {
                authMessage.style.color = '#EF4444';
                authMessage.textContent = "Username and password are required for login.";
                authSubmitButton.disabled = false;
                return;
            }
        }


        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            const data = await response.json();

            if (response.ok) {
                authMessage.style.color = '#48BB78';

                if (isAdminRegisterMode) { // Admin registration successful
                    authMessage.textContent = data.message || "Admin registration successful! Please log in as admin.";
                    showAuthSection(); // Reset to login view
                } else if (isRegisterMode) { // Regular user registration successful
                    authMessage.textContent = data.message || "Registration successful!";
                    if (plan === 'premium') {
                        showPaymentSection(username);
                    } else { // Trial registration
                        showAuthSection(); // Reset to login view
                        authMessage.textContent += " Please log in now.";
                    }
                } else { // Login mode successful
                    authMessage.textContent = data.message || "Login successful!";
                    if (data.token) {
                        localStorage.setItem('jwtToken', data.token);
                        localStorage.setItem('username', data.username);
                        localStorage.setItem('userId', data.id);
                        localStorage.setItem('roles', JSON.stringify(data.roles));
                        showScannerSection();
                    }
                }

            } else {
                authMessage.style.color = '#EF4444';
                authMessage.textContent = data.message || "An error occurred.";
            }
        } catch (error) {
            authMessage.style.color = '#EF4444';
            authMessage.textContent = `Connection error. Please try again.`; // Generic network error
            console.error("Auth fetch error:", error);
        } finally {
            authSubmitButton.disabled = false;
        }
    }

    function toggleAuthFormMode() {
        isAdminRegisterMode = false; // Always reset admin register mode when toggling
        isRegisterMode = !isRegisterMode;
        if (isRegisterMode) {
            authFormTitle.textContent = 'Register';
            authSubmitButton.textContent = 'Register';
            emailGroup.classList.remove('hidden');
            planGroup.classList.remove('hidden');
            toggleAuthModeButton.textContent = "Already have an account? Login here.";
            // registerAdminButton.classList.add('hidden'); // Admin registration button removed permanently
        } else {
            authFormTitle.textContent = 'Login';
            authSubmitButton.textContent = 'Login';
            emailGroup.classList.add('hidden');
            planGroup.classList.add('hidden');
            toggleAuthModeButton.textContent = "Don't have an account? Register here.";
            // registerAdminButton.classList.remove('hidden'); // Admin registration button removed permanently
        }
        authMessage.textContent = '';
        usernameInput.value = ''; // Clear inputs on mode switch
        passwordInput.value = '';
        emailInput.value = '';
    }

    // Function to switch to Admin Registration Mode (logic removed for security)
    // function switchToAdminRegisterMode() {
    //     isRegisterMode = true;
    //     isAdminRegisterMode = true;
    //     authFormTitle.textContent = 'Register Admin';
    //     authSubmitButton.textContent = 'Register Admin';
    //     emailGroup.classList.remove('hidden');
    //     planGroup.classList.add('hidden');
    //     toggleAuthModeButton.textContent = "Go back to regular Login/Register.";
    //     // registerAdminButton.classList.add('hidden');
    //     authMessage.textContent = '';
    //     usernameInput.value = '';
    //     passwordInput.value = '';
    //     emailInput.value = '';
    // }


    function handleLogout() {
        showAuthSection();
        authMessage.textContent = "You have been logged out.";
    }

    // --- Payment Functions ---
    async function handleSubmitPaymentProof(event) {
        event.preventDefault();
        paymentMessage.textContent = '';
        submitPaymentProofButton.disabled = true;

        const txHash = transactionHashInput.value;
        const userId = localStorage.getItem('pendingPaymentUsername');

        if (!txHash || !userId) {
            paymentMessage.style.color = '#EF4444';
            paymentMessage.textContent = "Transaction hash and user information are required.";
            submitPaymentProofButton.disabled = false;
            return;
        }

        const token = localStorage.getItem('jwtToken');
        if (!token) {
            paymentMessage.style.color = '#EF4444';
            paymentMessage.textContent = "Error: No authentication token found. Please log in first.";
            submitPaymentProofButton.disabled = false;
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/payment/submit-proof`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ transactionHash: txHash, userId: userId })
            });

            const data = await response.json();

            if (response.ok) {
                paymentMessage.style.color = '#48BB78';
                paymentMessage.textContent = data.message || "Payment proof submitted successfully! Your premium access will be activated soon.";
                localStorage.removeItem('pendingPaymentUsername');
                setTimeout(() => {
                    showAuthSection();
                    authMessage.textContent = "Payment proof submitted. Please log in to check your status later.";
                }, 3000);
            } else {
                paymentMessage.style.color = '#EF4444';
                paymentMessage.textContent = data.message || "Failed to submit payment proof.";
            }
        } catch (error) {
            paymentMessage.style.color = '#EF4444';
            paymentMessage.textContent = `Connection error. Please try again.`; // Generic network error
            console.error("Payment proof fetch error:", error);
        } finally {
            submitPaymentProofButton.disabled = false;
        }
    }


    // --- Function Definitions (Order matters for dependencies) ---

    function displayResults(resultsToDisplay) {
        resultsContainer.innerHTML = '';

        let filteredByPriceDeviation = resultsToDisplay.filter(coin => {
            if (coin.orderBlockType === 'None' || coin.orderBlockPrice === null || coin.orderBlockPrice === undefined) {
                return true;
            }
            const priceDiff = Math.abs(coin.orderBlockPrice - coin.currentPrice);
            const percentageDiff = (priceDiff / coin.currentPrice) * 100;
            return percentageDiff <= maxPriceDeviationPercent;
        });

        if (filteredByPriceDeviation.length === 0) {
            resultsContainer.innerHTML = '<p class="text-center text-gray-400 col-span-full">No order block data available for current filters.</p>';
            return;
        }

        filteredByPriceDeviation.forEach(coin => {
            const orderBlockTypeClass = coin.orderBlockType === 'Buying (Bullish)' ? 'buying-ob-border' :
                                        coin.orderBlockType === 'Selling (Bearish)' ? 'selling-ob-border' :
                                        'no-ob-border';

            const obPriceDisplay = coin.orderBlockPrice !== null && coin.orderBlockPrice !== undefined ? `$${parseFloat(coin.orderBlockPrice).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 8 })}` : 'N/A';
            const currentPriceDisplay = coin.currentPrice !== null && coin.currentPrice !== undefined ? parseFloat(coin.currentPrice).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 8 }) : 'N/A';

            resultsContainer.innerHTML += `
                <div class="coin-card ${orderBlockTypeClass}"
                     data-symbol="${coin.id}"
                     data-timeframe="${coin.timeframe}"
                     data-ob-type="${coin.obType}"
                     data-ob-price="${coin.obCandlePrice || 'N/A'}"
                     data-coin-name="${coin.name}"
                     data-ob-open="${coin.obCandleOpen || ''}"
                     data-ob-high="${coin.obCandleHigh || ''}"
                     data-ob-low="${coin.obCandleLow || ''}"
                     data-ob-close="${coin.obCandleClose || ''}"
                     data-ob-zone-start="${coin.obZoneStart || ''}"
                     data-ob-zone-end="${coin.obZoneEnd || ''}">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-2xl font-bold text-blue-300">${coin.name || 'N/A'} (${coin.id || 'N/A'})</h2>
                        <span class="text-lg font-semibold text-gray-300">Vol: ${coin.volume || 'N/A'}</span>
                    </div>
                    <p class="text-gray-400 mb-2">Current Price: <span class="text-white font-medium">$${currentPriceDisplay}</span></p>
                    <p class="text-gray-400 mb-2">Scan Time: <span class="text-white font-medium">${coin.timestamp || 'N/A'}</span></p>
                    <p class="text-gray-400 mb-2">Timeframe: <span class="text-white font-medium">${(coin.timeframe || 'N/A').toUpperCase()}</span></p>
                    <div class="mt-4 pt-4 border-t border-gray-600">
                        <p class="text-lg font-semibold mb-2">
                            Order Block Status: <span class="${
                                coin.orderBlockType === 'Buying (Bullish)' ? 'text-green-400' :
                                coin.orderBlockType === 'Selling (Bearish)' ? 'text-red-400' :
                                'text-gray-400'
                            }">
                                ${coin.orderBlockType || 'N/A'}
                            </span>
                        </p>
                        <p class="text-gray-300 mb-2">
                            Order Block Price Level: <span class="text-white font-bold">${obPriceDisplay}</span>
                        </p>
                        <p class="text-gray-400 text-sm mb-4">${coin.details || 'No additional details.'}</p>
                    </div>
                </div>
            `;
        });
        document.querySelectorAll('.coin-card').forEach(card => {
            card.addEventListener('click', openChartModal);
        });
    }

    function filterResults() {
        let filtered = [];
        if (currentFilter === 'All') {
            filtered = allScanResults;
        } else {
            filtered = allScanResults.filter(coin => coin.orderBlockType === currentFilter);
        }
        displayResults(filtered);
        statusMessage.textContent = `Displaying ${filtered.length} results (filtered by: ${currentFilter}, max deviation: ${maxPriceDeviationPercent}%).`;
        if (currentFilter === 'All') {
            statusMessage.textContent = `Scan complete! Found ${allScanResults.length} total results for ${currentTimeframe.toUpperCase()} timeframe with "${currentSensitivity}" sensitivity. Displaying ${resultsContainer.children.length} results after price deviation filter.`;
        }
    }

    function setFilter(filterType) {
        currentFilter = filterType;
        document.querySelectorAll('.filter-button').forEach(btn => {
            if (btn.dataset.filter === filterType) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        filterResults();
    }

    function setTimeframe(timeframe) {
        currentTimeframe = timeframe;
        document.querySelectorAll('.timeframe-button').forEach(btn => {
            if (btn.dataset.timeframe === timeframe) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        statusMessage.textContent = `Timeframe set to ${currentTimeframe.toUpperCase()}. Click Scan to update results.`;
    }

    function setSensitivity(sensitivityType) {
      currentSensitivity = sensitivityType;
      sensitivityButtons.forEach(btn => {
        if (btn.dataset.sensitivity === sensitivityType) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      statusMessage.textContent = `Detection sensitivity set to "${sensitivityType}". Click Scan to update results.`;
    }

    function clearResults() {
        allScanResults = [];
        currentFilter = 'All';
        setFilter('All');
        resultsContainer.innerHTML = '<p class="text-center text-gray-400 col-span-full">Results cleared.</p>';
        statusMessage.textContent = 'Click "Initiate Scan" to begin analyzing market data.';
        errorMessage.textContent = '';
    }

    async function fetchOrderBlocks() {
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            errorMessage.textContent = "Please log in to use the scanner.";
            showAuthSection();
            return;
        }

        scanButton.disabled = true;
        clearButton.disabled = true;
        document.querySelectorAll('.filter-button, .timeframe-button, .sensitivity-button').forEach(btn => btn.disabled = true);
        priceDeviationInput.disabled = true;


        spinner.classList.remove('hidden');
        buttonText.textContent = 'Scanning...';
        statusMessage.textContent = `Fetching real-time data and scanning for ${currentTimeframe.toUpperCase()} order blocks...`;
        errorMessage.textContent = '';
        resultsContainer.innerHTML = '';

        const selectedPreset = sensitivityPresets[currentSensitivity];
        if (!selectedPreset) {
            errorMessage.textContent = "Invalid sensitivity preset selected.";
            scanButton.disabled = false;
            clearButton.disabled = false;
            document.querySelectorAll('.filter-button, .timeframe-button, .sensitivity-button').forEach(btn => btn.disabled = false);
            priceDeviationInput.disabled = false;
            spinner.classList.add('hidden');
            buttonText.textContent = 'Initiate Scan';
            return;
        }

        const { minBodyRatio, minPriceChange, volumeFactor, requireBOS, requireC3ClosePastC2, requireFVG, requireUnmitigated, minFvgDepthRatio } = selectedPreset;


        try {
            const response = await fetch(`${API_BASE_URL}/scan-order-blocks?interval=${currentTimeframe}&minBodyRatio=${minBodyRatio}&minPriceChange=${minPriceChange}&volumeFactor=${volumeFactor}&requireBOS=${requireBOS}&requireC3ClosePastC2=${requireC3ClosePastC2}&requireFVG=${requireFVG}&requireUnmitigated=${requireUnmitigated}&minFvgDepthRatio=${minFvgDepthRatio}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                let errorDetail = `Status: ${response.status} ${response.statusText || 'Unknown Error'}`;
                try {
                    const errorBody = await response.json(); // Changed to .json() to parse JSON error messages
                    errorDetail = errorBody.message || JSON.stringify(errorBody); // Use message or stringify the whole object
                } catch (bodyError) {
                    errorDetail += `. Could not read response body: ${bodyError.message}`;
                }
                throw new Error(`Request failed: ${errorDetail}`); // Generic error message
            }

            const data = await response.json();
            allScanResults = data;
            filterResults();
            statusMessage.textContent = `Scan complete! Found ${data.length} total results for ${currentTimeframe.toUpperCase()} timeframe with "${currentSensitivity}" sensitivity. Displaying ${resultsContainer.children.length} results after price deviation filter.`;

        } catch (err) {
            statusMessage.textContent = '';
            errorMessage.textContent = `Connection/Data Error: ${err.message}. Please check your network connection and try again.`; // Generic error message
            console.error("Frontend fetch error:", err);
            allScanResults = [];
        } finally {
            scanButton.disabled = false;
            clearButton.disabled = false;
            document.querySelectorAll('.filter-button, .timeframe-button, .sensitivity-button').forEach(btn => btn.disabled = false);
            priceDeviationInput.disabled = false;
            spinner.classList.add('hidden');
            buttonText.textContent = 'Initiate Scan';
        }
    }

    // --- Chart Modal Functions ---
    function openChartModal(event) {
      const card = event.currentTarget;
      const symbol = card.dataset.symbol;
      const timeframe = card.dataset.timeframe;
      const obType = card.dataset.obType;
      const obPrice = card.dataset.obPrice;
      const coinName = card.dataset.coinName;
      const obOpen = card.dataset.obOpen;
      const obHigh = card.dataset.obHigh;
      const obLow = card.dataset.obLow;
      const obClose = card.dataset.obClose;
      const obZoneStart = card.dataset.obZoneStart;
      const obZoneEnd = card.dataset.obZoneEnd;


      modalTitle.textContent = `${coinName} (${symbol}) Chart - ${timeframe.toUpperCase()}`;

      let obZoneInfo = '';
      if (obType !== 'None' && obZoneStart && obZoneEnd) {
          obZoneInfo = ` | OB Zone: $${parseFloat(obZoneStart).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 8 })} - $${parseFloat(obZoneEnd).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 8 })}`;
      }

      modalOBInfo.innerHTML = `Order Block Status: <span class="${
          obType === 'Buying (Bullish)' ? 'text-green-400' :
          obType === 'Selling (Bearish)' ? 'text-red-400' :
          'text-gray-400'
      }">${obType}</span> | Price Level: <span class="text-white font-bold">${obPrice !== 'N/A' ? `$${parseFloat(obPrice).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 8 })}` : 'N/A'}</span>${obZoneInfo}`;

      let tvInterval = '240';
      if (timeframe === '1h') {
          tvInterval = '60';
      } else if (timeframe === '1d') {
          tvInterval = 'D';
      }

      document.getElementById('tradingview_chart').innerHTML = '';

      new TradingView.widget(
        {
          "width": "100%",
          "height": "100%",
          "symbol": `BINANCE:${symbol}`,
          "interval": tvInterval,
          "timezone": "Etc/UTC",
          "theme": "dark",
          "style": "1",
          "locale": "en",
          "toolbar_bg": "#f1f3f6",
          "enable_publishing": false,
          "allow_symbol_change": true,
          "container_id": "tradingview_chart"
        }
      );

      tradingViewLink.href = `https://www.tradingview.com/chart/?symbol=BINANCE:${symbol}.P&interval=${tvInterval}`;

      chartModal.classList.remove('hidden');
    }

    function closeChartModal() {
      chartModal.classList.add('hidden');
      document.getElementById('tradingview_chart').innerHTML = '';
    }


    // --- Initial Setup Calls ---
    displayResults([]);
    setTimeframe(currentTimeframe);
    setSensitivity(currentSensitivity);

    if (localStorage.getItem('jwtToken')) {
        showScannerSection();
    } else {
        showAuthSection();
    }


    // --- Event Listeners ---
    scanButton.addEventListener('click', fetchOrderBlocks);
    clearButton.addEventListener('click', clearResults);
    showAllButton.addEventListener('click', () => setFilter('All'));
    showBuyingButton.addEventListener('click', () => setFilter('Buying (Bullish)'));
    showSellingButton.addEventListener('click', () => setFilter('Selling (Bearish)'));
    timeframe1hButton.addEventListener('click', () => setTimeframe('1h'));
    timeframe4hButton.addEventListener('click', () => setTimeframe('4h'));
    timeframe1dButton.addEventListener('click', () => setTimeframe('1d'));

    sensitivityButtons.forEach(button => {
      button.addEventListener('click', () => {
        setSensitivity(button.dataset.sensitivity);
      });
    });

    priceDeviationInput.addEventListener('change', (event) => {
        const newValue = parseFloat(event.target.value);
        if (!isNaN(newValue) && newValue >= 0 && newValue <= 100) {
            maxPriceDeviationPercent = newValue;
            filterResults();
        } else {
            errorMessage.textContent = "Please enter a valid percentage between 0 and 100.";
            event.target.value = maxPriceDeviationPercent;
        }
    });

    closeModalButton.addEventListener('click', closeChartModal);
    chartModal.addEventListener('click', (event) => {
      if (event.target === chartModal) {
        closeChartModal();
      }
    });

    // Authentication Event Listeners
    authForm.addEventListener('submit', handleAuthSubmit);
    toggleAuthModeButton.addEventListener('click', toggleAuthFormMode);
    logoutButton.addEventListener('click', handleLogout);
    // registerAdminButton.addEventListener('click', switchToAdminRegisterMode); // Removed for security


    // Payment Event Listeners
    closePaymentModalButton.addEventListener('click', () => paymentModal.classList.add('hidden'));
    paymentModal.addEventListener('click', (event) => {
        if (event.target === paymentModal) {
            paymentModal.classList.add('hidden');
        }
    });
    paymentProofForm.addEventListener('submit', handleSubmitPaymentProof);

    // Admin Panel Event Listeners (NEW)
    adminPanelButton.addEventListener('click', showAdminPanel);
    closeAdminPanelModalButton.addEventListener('click', () => adminPanelModal.classList.add('hidden'));
    adminPanelModal.addEventListener('click', (event) => {
        if (event.target === adminPanelModal) {
            adminPanelModal.classList.add('hidden');
        }
    });

    // Premium Welcome Modal Event Listeners (NEW)
    closePremiumWelcomeModalButton.addEventListener('click', closePremiumWelcomeModal);
    closePremiumWelcomeModalX.addEventListener('click', closePremiumWelcomeModal);
    premiumWelcomeModal.addEventListener('click', (event) => {
        if (event.target === premiumWelcomeModal) {
            closePremiumWelcomeModal();
        }
    });


    // Load TradingView widget script dynamically
    const script = document.createElement('script');
    script.src = 'https://s3.tradingview.com/tv.js';
    script.async = true;
    document.head.appendChild(script);

    // Ripple effect for buttons
    document.querySelectorAll('.scan-button, .filter-button, .timeframe-button, .sensitivity-button, .chart-button, .auth-button, .payment-button').forEach(button => {
        button.addEventListener('click', function(e) {
            if (this.disabled) return;

            const ripple = document.createElement('span');
            ripple.classList.add('ripple');
            this.appendChild(ripple);

            const diameter = Math.max(this.clientWidth, this.clientHeight);
            const radius = diameter / 2;

            ripple.style.width = ripple.style.height = `${diameter}px`;
            ripple.style.left = `${e.clientX - this.getBoundingClientRect().left - radius}px`;
            ripple.style.top = `${e.clientY - this.getBoundingClientRect().top - radius}px`;

            ripple.addEventListener('animationend', () => {
                this.removeChild(ripple);
            });
        });
    });

</script>
</body>
</html>
