<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Order Block Scanner - Modern & Refined</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <style>
        /* --- Global Theme Variables (Modern Dark Theme) --- */
        :root {
            --color-dark-bg-primary: #121212; /* Deep charcoal */
            --color-dark-bg-secondary: #1E1E1E; /* Slightly lighter charcoal for cards */
            --color-dark-bg-alt: #282828; /* Darker grey for inputs/sections */
            --color-text-light: #E0E0E0; /* Light grey text */
            --color-text-secondary: #B0B0B0; /* Muted grey text */
            --color-accent-blue: #00BFFF; /* Deep Sky Blue */
            --color-accent-blue-dark: #009ACD;
            --color-accent-blue-light: #4DD0FF;
            --color-accent-purple: #9370DB; /* Medium Purple */
            --color-accent-purple-light: #A78BFA;
            --color-red-accent: #FF6347; /* Tomato */
            --color-red-light: #FF8C6A; /* Lighter Red */
            --color-green-accent: #32CD32; /* Lime Green */
            --color-orange-accent: #FFA500; /* Orange */
            --color-glowing-text-shadow: 0 0 8px rgba(0, 191, 255, 0.7), 0 0 15px rgba(0, 191, 255, 0.5);
            --color-border-dark: #444444; /* Subtle border */
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.5);
            --shadow-deep: 0 12px 25px rgba(0, 0, 0, 0.6);

            /* Light Mode Variables (default, but will be overridden by dark theme) */
            --lm-bg-primary: #F0F2F5;
            --lm-bg-secondary: #FFFFFF;
            --lm-bg-alt: #E2E8F0;
            --lm-text-primary: #2D3748;
            --lm-text-secondary: #718096;
            --lm-border: #CBD5E0;
            --lm-input-bg: #FFFFFF;
            --lm-input-border: #CBD5E0;
            --lm-toast-bg: #2D3748;
            --lm-toast-text: white;
            --lm-table-header-bg: #E2E8F0;
            --lm-table-row-even-bg: #F7FAFC;
        }

        /* Base styles for light mode (default) and animated background */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            /* Animated gradient background for the body - now using dark theme colors directly */
            background: linear-gradient(-45deg, var(--color-dark-bg-primary), #2a2a2a, var(--color-dark-bg-primary), #3a3a3a);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            color: var(--color-text-light); /* Default to light text for dark theme */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to the top */
            align-items: center;
            transition: background-color 0.5s ease, color 0.5s ease;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Dark Mode Overrides - Ensure these are always active for this theme */
        html.dark, html { /* Apply dark theme variables by default */
            --lm-bg-primary: var(--color-dark-bg-primary);
            --lm-bg-secondary: var(--color-dark-bg-secondary);
            --lm-bg-alt: var(--color-dark-bg-alt);
            --lm-text-primary: var(--color-text-light);
            --lm-text-secondary: var(--color-text-secondary);
            --lm-border: var(--color-border-dark);
            --lm-input-bg: var(--color-dark-bg-primary);
            --lm-input-border: var(--color-border-dark);
            --lm-toast-bg: var(--color-dark-bg-secondary);
            --lm-toast-text: var(--color-text-light);
            --lm-table-header-bg: var(--color-dark-bg-primary);
            --lm-table-row-even-bg: var(--color-dark-bg-alt);
        }

        /* Ensure body background is always dark theme's gradient */
        html.dark body, body {
            background: linear-gradient(-45deg, var(--color-dark-bg-primary), #2a2a2a, var(--color-dark-bg-primary), #3a3a3a);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            color: var(--lm-text-primary);
        }

        /* Container and Header Area */
        .container {
            max-width: 1152px;
            width: 95%;
            margin: 20px auto;
            padding: 20px;
            background-color: var(--lm-bg-secondary);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-lg);
            transition: background-color 0.5s ease, box-shadow 0.5s ease;
            z-index: 10; /* Ensure container is above body background */
            position: relative; /* For z-index to work */
        }
        .header-area {
            background-image: linear-gradient(to right, var(--lm-bg-primary), var(--lm-bg-secondary));
            padding-bottom: 1rem;
            border-radius: 0.75rem 0.75rem 0 0;
            overflow: hidden;
            transition: background-image 0.5s ease;
            border-bottom: 1px solid var(--lm-border); /* Added subtle border */
        }
        h1, h2, h3 {
            font-family: 'Roboto', sans-serif;
            letter-spacing: 0.025em;
            color: var(--lm-text-primary);
        }
        .logo-icon-wrapper {
            border-radius: 50%;
            padding: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            background-color: var(--lm-bg-primary);
            box-shadow: var(--shadow-md);
        }
        .logo-icon-wrapper:hover {
            transform: rotate(10deg) scale(1.05);
            box-shadow: 0 0 20px var(--color-accent-purple-light);
        }

        /* Buttons */
        .scan-button {
            background-image: linear-gradient(to right, var(--color-accent-blue) 0%, var(--color-accent-blue-light) 51%, var(--color-accent-blue) 100%);
            transition: background-color 0.4s ease-in-out, transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease-in-out;
            background-size: 200% auto;
            color: white;
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.5); /* Adjusted glow for Modern Dark */
            border-radius: 9999px;
            padding: 12px 30px;
            font-weight: 700;
            font-size: 1.25rem;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            transform: translateY(0);
        }
        .scan-button:hover {
            background-position: right center;
            box-shadow: 0 0 30px var(--color-accent-purple);
            transform: translateY(-3px);
        }
        .scan-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .scan-button .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            animation: ripple-effect 0.6s linear;
            transform: scale(0);
            opacity: 1;
        }
        @keyframes ripple-effect {
            to {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        .action-button {
            background-color: var(--lm-bg-alt);
            color: var(--lm-text-primary);
            padding: 10px 20px;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--lm-border);
            transition: background-color 0.4s ease-in-out, border-color 0.4s ease-in-out, box-shadow 0.3s ease-in-out, transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s ease-in-out;
            box-shadow: var(--shadow-md);
            transform: translateY(0);
        }
        .action-button:hover:not(:disabled) {
            background-color: var(--lm-border); /* Slightly darker gray */
            border-color: var(--color-accent-blue);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); /* Adjusted for dark theme */
            transform: translateY(-2px);
        }
        .action-button.active {
            background-color: var(--color-accent-blue) !important;
            border-color: var(--color-accent-blue-dark) !important;
            color: white !important;
            font-weight: 700;
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.5); /* Adjusted for Modern Dark */
            transform: translateY(0);
        }
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Specific hover for admin buttons */
        .grant-premium-btn:hover:not(:disabled) { background-color: var(--color-green-accent); border-color: var(--color-green-accent); }
        .revoke-premium-btn:hover:not(:disabled) { background-color: var(--color-red-accent); border-color: var(--color-red-accent); }
        .activate-trial-btn:hover:not(:disabled) { background-color: var(--color-accent-blue-dark); border-color: var(--color-accent-blue-dark); }

        /* --- NEW GLASSMORPHISM CARD STYLES --- */
        /* Renamed .container to .glass-container to avoid conflicts */
        .glass-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px; /* For 3D transform effect */
            height: 100%; /* Ensure container takes full height in grid cell */
            width: 100%; /* Ensure container takes full width in grid cell */
        }

        /* Renamed .glass to .glass-card */
        .glass-card {
            position: relative;
            width: 100%; /* Make it responsive */
            max-width: 250px; /* Max width for larger screens */
            height: 400px; /* Increased height to accommodate more info, was 350px */
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); /* Subtle white gradient */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column; /* Stack content vertically */
            justify-content: space-between; /* Space out content */
            align-items: center;
            transition: 0.5s;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            padding: 1rem; /* Add padding */
            color: var(--color-text-light); /* Use theme text color */
            text-align: center;
            overflow: hidden; /* Hide overflow for content */
        }

        .glass-container:hover .glass-card {
            transform: translateY(-10px) scale(1.02); /* Lift and slightly enlarge on hover */
            box-shadow: 0 25px 35px rgba(0, 0, 0, 0.35);
        }

        .glass-card::before {
            content: attr(data-text);
            position: absolute;
            top: 0; /* Position at the top */
            width: 100%;
            padding: 8px 0; /* Add padding */
            background: rgba(255, 255, 255, 0.08); /* Slightly more opaque background for header */
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--color-text-light); /* Use theme text color */
            font-weight: 600;
            font-size: 1.1em;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15); /* Separator line */
            z-index: 1; /* Ensure it's above content */
        }

        .glass-card .content {
            flex-grow: 1; /* Allow content to take available space */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to top within its space */
            align-items: center;
            padding-top: 50px; /* Offset for the ::before header */
            width: 100%;
            text-align: left; /* Align text left within content */
            overflow-y: auto; /* Add scrollbar if content overflows */
            scrollbar-width: thin; /* For Firefox */
            scrollbar-color: var(--color-accent-blue) transparent; /* For Firefox */
        }

        /* Custom scrollbar for Webkit browsers */
        .glass-card .content::-webkit-scrollbar {
            width: 8px;
        }

        .glass-card .content::-webkit-scrollbar-track {
            background: transparent;
        }

        .glass-card .content::-webkit-scrollbar-thumb {
            background-color: var(--color-accent-blue);
            border-radius: 10px;
            border: 2px solid transparent;
        }


        .glass-card .content h2 {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--color-accent-blue); /* Use accent color for main heading */
            margin-bottom: 0.5rem;
        }

        .glass-card .content p {
            font-size: 0.9em;
            color: var(--color-text-secondary);
            margin-bottom: 0.25rem;
        }

        .glass-card .content .ob-details {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            text-align: left;
        }

        .glass-card .content .ob-details p {
            font-size: 0.8em;
            margin-bottom: 0.1rem;
        }

        .glass-card .content .ob-details .price-level {
            font-weight: 700;
            color: var(--color-text-light);
        }

        .glass-card .content .ob-details .ob-type {
            font-weight: 600;
        }

        /* Specific border colors for the glass cards */
        .glass-card.buying-ob-border { border-color: var(--color-green-accent); }
        .glass-card.selling-ob-border { border-color: var(--color-red-accent); }
        .glass-card.no-ob-border { border-color: var(--color-border-dark); } /* Use a subtle border for no OB */

        /* Adjust results container grid to center items */
        #resultsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Flexible columns */
            gap: 24px; /* Space between cards */
            justify-items: center; /* Center cards within their grid cells */
            align-items: stretch; /* Stretch cards to fill height */
        }

        /* Ensure images/SVGs within glass cards are styled */
        .glass-card svg {
            font-size: 2.5em; /* Keep original SVG size */
            fill: var(--color-accent-blue); /* Use accent color for SVGs */
            margin-bottom: 10px; /* Space below SVG */
        }

        /* Adjust skeleton card to new dimensions */
        .skeleton-card {
            height: 400px; /* Match glass-card height, was 350px */
            background-color: rgba(255, 255, 255, 0.05); /* Subtle transparent background */
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            backdrop-filter: blur(5px);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        .skeleton-card .skeleton-line {
            background-color: rgba(255, 255, 255, 0.15); /* More subtle skeleton lines */
        }


        /* Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2); /* Adjusted for dark mode visibility */
            border-radius: 50%;
            border-top: 4px solid var(--color-accent-blue); /* Blue spinner */
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Parameters Section & Inputs */
        .parameters-section {
            background-color: var(--lm-bg-alt);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
            transition: background-color 0.5s ease, box-shadow 0.5s ease;
            border: 1px solid var(--lm-border);
        }
        .param-input-group input[type="number"],
        .param-input-group input[type="text"],
        .param-input-group input[type="email"],
        .param-input-group input[type="password"],
        .param-input-group select {
            width: 100%;
            max-width: 250px;
            padding: 0.6rem 0.85rem;
            border-radius: 0.375rem;
            background-color: var(--lm-input-bg);
            color: var(--lm-text-primary);
            border: 1px solid var(--lm-input-border);
            text-align: left;
            font-size: 0.9rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.5s ease, color 0.5s ease;
        }
        .param-input-group input[type="number"]:focus,
        .param-input-group input[type="text"]:focus,
        .param-input-group input[type="email"]:focus,
        .param-input-group input[type="password"]:focus,
        .param-input-group select:focus {
            outline: none;
            border-color: var(--color-accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.3); /* Adjusted for Modern Dark */
        }

        /* Slider specific styles */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, var(--color-accent-blue-light) 0%, var(--lm-border) 100%); /* Gradient track */
            outline: none;
            opacity: 0.9;
            -webkit-transition: .2s;
            transition: opacity .2s, background 0.4s ease;
            border-radius: 5px;
        }

        input[type="range"]:hover {
            opacity: 1;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--color-accent-blue);
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.3); /* Adjusted for Modern Dark */
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--color-accent-blue);
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.3); /* Adjusted for Modern Dark */
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }

        /* Tooltip for sensitivity buttons */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--lm-toast-bg);
            color: var(--lm-toast-text);
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position above the button */
            left: 50%;
            margin-left: -100px; /* Center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            line-height: 1.2;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--lm-border);
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%; /* At the bottom of the tooltip */
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--lm-toast-bg) transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }


        /* Modals */
        .modal {
            position: fixed;
            z-index: 1000; /* High z-index to overlay everything */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7); /* Semi-transparent overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--lm-bg-secondary);
            margin: auto;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); /* Adjusted for Modern Dark */
            width: 90%;
            padding: 1.5rem;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transform: translateY(20px);
            transition: transform 0.3s ease, background-color 0.5s ease, box-shadow 0.5s ease;
            max-height: 90vh;
            overflow-y: auto;
            color: var(--lm-text-primary);
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .close-button {
            color: var(--lm-text-secondary);
            position: sticky;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001; /* Above modal content */
            align-self: flex-end;
            background-color: var(--lm-bg-secondary);
            border-radius: 50%;
            padding: 0 8px;
            transition: color 0.2s ease, background-color 0.5s ease;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--lm-text-primary);
            background-color: var(--lm-bg-alt);
        }
        .chart-container {
            height: 80vh;
            max-height: 700px;
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: var(--color-dark-bg-primary); /* Chart background */
        }
        .modal-header-sticky {
            position: sticky;
            top: 0;
            background-color: var(--lm-bg-secondary);
            padding: 10px 20px;
            margin: -20px -20px 15px -20px;
            border-bottom: 1px solid var(--lm-border);
            z-index: 10;
            border-radius: 0.75rem 0.75rem 0 0;
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        #paymentModal .modal-content { max-width: 500px; text-align: center; }
        #paymentModal .payment-info {
            background-color: var(--lm-bg-alt);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            color: var(--lm-text-primary);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        #adminPanelModal .modal-content { max-width: 1024px; }
        #premiumWelcomeModal .modal-content { max-width: 500px; text-align: center; }
        #onboardingModal .modal-content { max-width: 600px; }


        .user-table-header th {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--lm-border);
            color: var(--lm-text-secondary);
            font-weight: 700;
            letter-spacing: 0.025em;
            background-color: var(--lm-table-header-bg);
            transition: background-color 0.5s ease, border-color 0.5s ease, color 0.5s ease;
        }
        .user-table-row td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--lm-border);
            transition: background-color 0.5s ease, border-color 0.5s ease, color 0.5s ease;
        }
        .user-table-row:nth-child(even) {
            background-color: var(--lm-table-row-even-bg);
            transition: background-color 0.5s ease;
        }
        .user-table-row:last-child td { border-bottom: none; }
        .user-table-row button { margin-right: 0.5rem; }

        #premiumWelcomeModal ul, #onboardingModal ul { list-style: none; padding: 0; margin-top: 1rem; text-align: left; color: var(--lm-text-secondary); }
        #premiumWelcomeModal ul li, #onboardingModal ul li { margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        #premiumWelcomeModal ul li svg, #onboardingModal ul li svg { color: var(--color-green-accent); flex-shrink: 0; }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000; /* Very high z-index */
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 350px;
        }
        .toast {
            background-color: var(--lm-toast-bg);
            color: var(--lm-toast-text);
            padding: 15px 20px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); /* Adjusted for Modern Dark */
            opacity: 0;
            transform: translateY(-20px);
            animation: slideInFadeIn 0.3s forwards, fadeOut 0.3s 2.7s forwards;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .toast.success { background-color: var(--color-green-accent); }
        .toast.error { background-color: var(--color-red-accent); }
        .toast.info { background-color: var(--color-accent-blue); }

        @keyframes slideInFadeIn {
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* Floating Action Button (FAB) */
        .fab-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            z-index: 999; /* Below modals, above content */
        }
        .fab-button {
            background-image: linear-gradient(to right, var(--color-accent-blue) 0%, var(--color-accent-blue-light) 51%, var(--color-accent-blue) 100%);
            transition: 0.5s, transform 0.2s ease;
            background-size: 200% auto;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 191, 255, 0.4); /* Adjusted for Modern Dark */
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            border: none;
            position: relative;
            overflow: hidden;
            transform: scale(1);
        }
        .fab-button:hover {
            background-position: right center;
            box-shadow: 0 6px 15px rgba(0, 191, 255, 0.6); /* Adjusted for Modern Dark */
            transform: scale(1.05);
        }
        /* FAB Button colors using new variables */
        .fab-button.green {
            background-image: linear-gradient(to right, var(--color-green-accent) 0%, #66DD66 51%, var(--color-green-accent) 100%); /* Adjusted for Modern Dark */
            box-shadow: 0 4px 10px rgba(50, 205, 50, 0.4); /* Adjusted for Modern Dark */
        }
        .fab-button.green:hover {
            box-shadow: 0 6px 15px rgba(50, 205, 50, 0.6); /* Adjusted for Modern Dark */
        }
        .fab-button.orange {
            background-image: linear-gradient(to right, var(--color-orange-accent) 0%, #FFC04D 51%, var(--color-orange-accent) 100%); /* Adjusted for Modern Dark */
            box-shadow: 0 4px 10px rgba(255, 165, 0, 0.4); /* Adjusted for Modern Dark */
        }
        .fab-button.orange:hover {
            box-shadow: 0 6px 15px rgba(255, 165, 0, 0.6); /* Adjusted for Modern Dark */
        }
        .fab-button.red {
            background-image: linear-gradient(to right, var(--color-red-accent) 0%, var(--color-red-light) 51%, var(--color-red-accent) 100%);
            box-shadow: 0 4px 10px rgba(255, 99, 71, 0.4); /* Adjusted for Modern Dark */
        }
        .fab-button.red:hover {
            box-shadow: 0 6px 15px rgba(255, 99, 71, 0.6); /* Adjusted for Modern Dark */
        }
        .fab-button.purple {
            background-image: linear-gradient(to right, var(--color-accent-purple) 0%, var(--color-accent-purple-light) 51%, var(--color-accent-purple) 100%);
            box-shadow: 0 4px 10px rgba(147, 112, 219, 0.4); /* Adjusted for Modern Dark */
        }
        .fab-button.purple:hover {
            box-shadow: 0 6px 15px rgba(147, 112, 219, 0.6); /* Adjusted for Modern Dark */
        }
        .fab-button.blue { /* Default blue for logout */
            background-image: linear-gradient(to right, var(--color-accent-blue) 0%, var(--color-accent-blue-light) 51%, var(--color-accent-blue) 100%);
            box-shadow: 0 4px 10px rgba(0, 191, 255, 0.4); /* Adjusted for Modern Dark */
        }
        .fab-button.blue:hover {
            box-shadow: 0 6px 15px rgba(0, 191, 255, 0.6); /* Adjusted for Modern Dark */
        }

        .fab-menu {
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
        }
        .fab-menu.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        .fab-button svg, .fab-button i { /* Include i for Font Awesome icons */
            transition: transform 0.3s ease;
        }
        .fab-button.rotate-45 svg {
            transform: rotate(45deg);
        }

        /* Dark/Light Mode Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background-color: var(--lm-bg-secondary);
            color: var(--lm-text-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
        }
        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Media queries for smaller screens */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px auto;
            }
            .scanner-main-buttons {
                display: none;
            }
            .action-button {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            .param-input-group input[type="number"],
            .param-input-group input[type="text"],
            .param-input-group input[type="email"],
            .param-input-group input[type="password"],
            .param-input-group select {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            .chart-container {
                height: 60vh;
                max-height: 400px;
            }
            .close-button {
                font-size: 24px;
                top: 5px;
                right: 10px;
            }
            .modal-header-sticky {
                padding: 8px 15px;
                margin: -15px -15px 10px -15px;
            }
            .user-table-header th, .user-table-row td {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            .fab-container {
                bottom: 10px;
                right: 10px;
            }
            #toast-container {
                top: auto;
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: calc(100% - 20px);
            }
            /* Responsive adjustments for glass cards */
            .glass-card {
                max-width: 90%; /* Allow cards to take more width on small screens */
                height: 350px; /* Slightly smaller height on mobile, was 300px */
            }
            .glass-card .content {
                padding-top: 40px;
            }
            .glass-card::before {
                font-size: 1em;
                padding: 6px 0;
            }
        }
    </style>
</head>
<body>
<div id="toast-container"></div> <!-- Toast container -->

<div class="theme-toggle" id="themeToggle" aria-label="Toggle dark and light theme">
    <!-- Sun icon for light mode, Moon for dark mode -->
    <svg class="w-6 h-6 sun-icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" style="display: block;">
        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 00-.707-.293h-1a1 1 0 000 2h1a1 1 0 00.707-.293l.707-.707a1 1 0 00-1.414-1.414l-.707.707zM17 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zm-9.464 4.95l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM3 10a1 1 0 01-1 1H2a1 1 0 110-2h1a1 1 0 011 1zm8.464-10.607l-.707-.707a1 1 0 00-1.414 1.414l.707.707a1 1 0 001.414-1.414zM10 15a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z" clip-rule="evenodd"></path>
    </svg>
    <svg class="w-6 h-6 moon-icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
    </svg>
</div>

<div class="container" data-aos="fade-up">
    <div class="header-area py-8 px-6 text-center rounded-xl">
        <h1 class="text-4xl lg:text-5xl font-bold text-center text-blue-600 mb-4 tracking-wide flex items-center justify-center gap-3">
            <!-- Logo SVG with new styling and hover animation -->
            <div class="logo-icon-wrapper shadow-md">
                <svg class="w-10 h-10 text-purple-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                    <path d="M12 11.25c-1.38 0-2.5 1.12-2.5 2.5s1.12 2.5 2.5 2.5 2.5-1.12 2.5-2.5-1.12-2.5-2.5-2.5zm0 3.5c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
                </svg>
            </div>
            <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-700">
                Crypto Order Block Scanner
            </span>
        </h1>
        <p class="text-lg text-gray-400 mb-4">
            Unlock powerful insights into market order blocks.
        </p>
    </div>

    <!-- Authentication Section (Initially visible - display:flex for proper centering) -->
    <div id="authSection" class="bg-lm-bg-secondary p-6 rounded-xl shadow-lg mb-8 max-w-md mx-auto transition-colors duration-500 flex flex-col items-center justify-center">
        <h2 id="authFormTitle" class="text-2xl font-bold text-color-accent-blue text-center mb-4">Login</h2>
        <form id="authForm" class="flex flex-col gap-4 w-full">
            <div class="param-input-group">
                <label for="username" class="text-lm-text-secondary font-medium">Username:</label>
                <input type="text" id="username" name="username" required class="w-full" aria-label="Username">
            </div>
            <div class="param-input-group">
                <label for="password" class="text-lm-text-secondary font-medium">Password:</label>
                <input type="password" id="password" name="password" required class="w-full" aria-label="Password">
            </div>
            <div id="emailGroup" class="param-input-group hidden">
                <label for="email" class="text-lm-text-secondary font-medium">Email:</label>
                <input type="email" id="email" name="email" class="w-full" aria-label="Email">
            </div>
            <div id="planGroup" class="param-input-group hidden">
                <label for="plan" class="text-lm-text-secondary font-medium">Plan:</label>
                <select id="plan" name="plan" class="w-full px-3 py-2 rounded-md bg-lm-input-bg text-lm-text-primary border border-lm-input-border focus:outline-none focus:ring-2 focus:ring-color-accent-blue" aria-label="Select Plan">
                    <option value="trial">3-Day Trial</option>
                    <option value="premium">Premium</option>
                </select>
            </div>
            <button type="submit" id="authSubmitButton" class="scan-button w-full" aria-label="Submit Authentication">Login</button>
        </form>
        <p class="text-center mt-4">
            <button id="toggleAuthMode" class="text-color-accent-blue hover:underline action-button bg-transparent border-none shadow-none px-0 py-0 font-normal" aria-label="Toggle authentication mode">Don't have an account? Register here.</button>
        </p>
    </div>

    <!-- Scanner Section (Initially hidden with display:none) -->
    <div id="scannerSection" class="hidden" style="display: none;">
        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4" data-aos="fade-up">
            <div class="flex flex-col md:flex-row justify-center items-center gap-4 w-full md:w-auto scanner-main-buttons">
                <button id="scanButton" class="scan-button w-full md:w-auto" aria-label="Initiate Scan">
                    <span id="spinner" class="spinner hidden"></span>
                    <span id="buttonText">Initiate Scan</span>
                </button>
                <button id="clearButton" class="action-button w-full md:w-auto" aria-label="Clear Results">Clear Results</button>
            </div>
            <button id="logoutButton" class="action-button bg-color-red-accent hover:bg-color-red-light text-white w-full md:w-auto" aria-label="Logout">Logout</button>
        </div>


        <div class="flex justify-center gap-3 mb-6 flex-wrap" data-aos="fade-up" data-aos-delay="100">
            <span class="text-lm-text-secondary font-semibold self-center">Timeframe:</span>
            <button id="timeframe15mButton" class="action-button" data-timeframe="15m" aria-label="15 Minute Timeframe">15M</button>
            <button id="timeframe30mButton" class="action-button" data-timeframe="30m" aria-label="30 Minute Timeframe">30M</button>
            <button id="timeframe1hButton" class="action-button" data-timeframe="1h" aria-label="1 Hour Timeframe">1H</button>
            <button id="timeframe4hButton" class="action-button active" data-timeframe="4h" aria-label="4 Hour Timeframe">4H</button>
            <button id="timeframe1dButton" class="action-button" data-timeframe="1d" aria-label="1 Day Timeframe">1D</button>
        </div>

        <div class="flex justify-center gap-3 mb-6 flex-wrap" data-aos="fade-up" data-aos-delay="200">
            <span class="text-lm-text-secondary font-semibold self-center">Filter:</span>
            <button id="showAllButton" class="action-button active" data-filter="All" aria-label="Show All Order Blocks">Show All</button>
            <button id="showBuyingButton" class="action-button" data-filter="Buying (Bullish)" aria-label="Show Buying Order Blocks">Show Buying OB</button>
            <button id="showSellingButton" class="action-button" data-filter="Selling (Bearish)" aria-label="Show Selling Order Blocks">Show Selling OB</button>
        </div>

        <!-- New section for Order Block Detection Parameters and Price Deviation -->
        <div class="parameters-section" data-aos="fade-up" data-aos-delay="300">
            <h2 class="text-2xl font-bold text-color-accent-blue text-center mb-4">Detection Sensitivity</h2>
            <div class="parameters-grid mb-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-2">
                <div class="tooltip-container">
                    <button class="sensitivity-button action-button" data-sensitivity="lowest" aria-label="Lowest Sensitivity">Lowest Condition</button>
                    <span class="tooltip-text" id="tooltip-lowest"></span>
                </div>
                <div class="tooltip-container">
                    <button class="sensitivity-button action-button" data-sensitivity="low-mid" aria-label="Low-Mid Sensitivity">Low Mid</button>
                    <span class="tooltip-text" id="tooltip-low-mid"></span>
                </div>
                <div class="tooltip-container">
                    <button class="sensitivity-button action-button active" data-sensitivity="mid" aria-label="Mid Sensitivity">Mid</button>
                    <span class="tooltip-text" id="tooltip-mid"></span>
                </div>
                <div class="tooltip-container">
                    <button class="sensitivity-button action-button" data-sensitivity="mid-high" aria-label="Mid-High Sensitivity">Mid High</button>
                    <span class="tooltip-text" id="tooltip-mid-high"></span>
                </div>
                <div class="tooltip-container">
                    <button class="sensitivity-button action-button" data-sensitivity="high" aria-label="High Sensitivity">High</button>
                    <span class="tooltip-text" id="tooltip-high"></span>
                </div>
                <div class="tooltip-container">
                    <button class="sensitivity-button action-button" data-sensitivity="extreme" aria-label="Extreme Sensitivity">Extreme Detection</button>
                    <span class="tooltip-text" id="tooltip-extreme"></span>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row items-center justify-center gap-3 mt-4">
                <label for="priceDeviation" class="text-lm-text-secondary font-semibold">Max Price Deviation (%):</label>
                <input type="range" id="priceDeviation" value="20" min="0" max="100" step="1" class="w-full max-w-xs" aria-label="Max Price Deviation Percentage">
                <span id="priceDeviationValue" class="text-lm-text-primary font-bold w-12 text-center">20%</span>
            </div>
        </div>

        <div id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Scan results or skeleton loaders will be injected here -->
        </div>

        <!-- Admin Panel Button -->
        <div class="text-center mt-8" data-aos="fade-up" data-aos-delay="400">
            <button id="adminPanelButton" class="action-button hidden bg-color-accent-purple hover:bg-color-accent-purple text-white" aria-label="Open User Management Panel">User Management (Admin)</button>
        </div>
    </div>
</div>

<!-- Floating Action Button (FAB) for Mobile -->
<div class="fab-container md:hidden">
    <button id="fabToggle" class="fab-button" aria-label="Toggle Mobile Menu">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>
    <div id="fabMenu" class="fab-menu">
        <button id="fabScanButton" class="fab-button green" aria-label="Initiate Scan (Mobile)">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </button>
        <button id="fabClearButton" class="fab-button orange" aria-label="Clear Results (Mobile)">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
        </button>
        <button id="fabAdminButton" class="fab-button purple hidden" aria-label="User Management (Mobile)">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h2a2 2 0 002-2V4a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h2m0 0l3-3m-3 3l-3-3m3 3v3m0-6h.01M6 14h.01M6 17h.01M6 20h.01M12 6h.01M12 10h.01M12 14h.01M12 18h.01"></path></svg>
        </button>
        <button id="fabPaymentButton" class="fab-button red" title="Manage Subscription" aria-label="Manage Subscription (Mobile)">
                <i class="fas fa-credit-card"></i>
            </button>
        <button id="fabLogoutButton" class="fab-button blue" title="Logout" aria-label="Logout (Mobile)">
                <i class="fas fa-sign-out-alt"></i>
            </button>
    </div>
</div>


<!-- Chart Modal Structure -->
<div id="chartModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
        <span class="close-button" id="closeModal" aria-label="Close Chart Modal">&times;</span>
        <div class="modal-header-sticky">
            <h3 id="modalTitle" class="text-2xl font-bold text-color-accent-blue text-center mb-2"></h3>
            <p id="modalOBInfo" class="text-center text-lm-text-secondary text-sm"></p>
        </div>
        <div id="lightweightChartContainer" class="chart-container">
            <!-- Lightweight Chart will be rendered here -->
        </div>
    </div>
</div>

<!-- Payment Modal Structure -->
<div id="paymentModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="paymentModalTitle">
    <div class="modal-content max-w-xl">
        <span class="close-button" id="closePaymentModal" aria-label="Close Payment Modal">&times;</span>
        <h3 id="paymentModalTitle" class="text-2xl font-bold text-color-accent-blue text-center mb-4">Premium Plan Payment</h3>
        <p class="text-lm-text-secondary mb-4">
            To activate your Premium plan, please send payment to the address below.
            After payment, submit your transaction hash.
        </p>
        <div class="payment-info p-4 rounded-md text-lm-text-primary mb-4">
            <p class="font-semibold">Payment Address (USDT BEP20):</p>
            <p class="break-all text-color-green-accent text-lg font-mono">0xe076e29832351413895b42b8ae936bebeb510d2e</p> <!-- REPLACE WITH YOUR ACTUAL ADDRESS -->
            <p class="mt-2 font-semibold">Amount: $25 USD</p>
        </div>
        <form id="paymentProofForm" class="flex flex-col gap-4">
            <div class="param-input-group">
                <label for="transactionHash" class="text-lm-text-secondary font-medium">Transaction Hash (TxID):</label>
                <input type="text" id="transactionHash" name="transactionHash" required class="w-full" aria-label="Transaction Hash (TxID)">
            </div>
            <button type="submit" id="submitPaymentProofButton" class="action-button w-full bg-color-accent-blue hover:bg-color-accent-blue-dark text-white" aria-label="Submit Payment Proof">Submit Payment Proof</button>
        </form>
    </div>
</div>

<!-- Admin Panel Modal Structure -->
<div id="adminPanelModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="adminPanelModalTitle">
    <div class="modal-content max-w-5xl">
        <span class="close-button" id="closeAdminPanelModal" aria-label="Close Admin Panel Modal">&times;</span>
        <h3 id="adminPanelModalTitle" class="text-2xl font-bold text-color-accent-blue text-center mb-4">User Management Panel</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-lm-bg-primary rounded-lg shadow-md">
                <thead>
                <tr class="user-table-header">
                    <th>Username</th>
                    <th>Email</th>
                    <th>Premium</th>
                    <th>Trial Active</th>
                    <th class="hidden sm:table-cell">Trial Expiry</th> <!-- Hidden on small screens -->
                    <th class="hidden sm:table-cell">Roles</th> <!-- Hidden on small screens -->
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="userTableBody">
                <!-- User data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Premium Welcome Modal -->
<div id="premiumWelcomeModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="premiumWelcomeModalTitle">
    <div class="modal-content max-w-xl">
        <span class="close-button" id="closePremiumWelcomeModal" aria-label="Close Premium Welcome Modal">&times;</span>
        <h3 id="premiumWelcomeModalTitle" class="text-3xl font-bold text-color-accent-blue text-center mb-4">Welcome to Premium!</h3>
        <p class="text-lm-text-secondary mb-4">
            Congratulations on unlocking the full power of the Crypto Order Block Scanner!
            Here's what you can now do:
        </p>
        <ul class="text-lg text-lm-text-primary mb-6">
            <li><i class="fas fa-check-circle text-color-green-accent mr-2"></i>
                **All Timeframes Unlocked:** Scan for Order Blocks on 15M, 30M, 1H, 4H, and 1D charts for deeper market analysis.
            </li>
            <li><i class="fas fa-check-circle text-color-green-accent mr-2"></i>
                **Full Sensitivity Control:** Utilize all 6 detection sensitivity levels (Lowest to Extreme) to fine-tune your scans.
            </li>
            <li><i class="fas fa-check-circle text-color-green-accent mr-2"></i>
                **Advanced Charting:** Click on any coin card to view its Order Block directly on a TradingView chart.
            </li>
            <li><i class="fas fa-check-circle text-color-green-accent mr-2"></i>
                **Trade Setup Suggestions:** Get suggested Entry, Stop Loss, and Take Profit levels for detected order blocks.
            </li>
            <li><i class="fas fa-check-circle text-color-green-accent mr-2"></i>
                **Admin Panel Access (for Admins):** Manage users and their premium/trial statuses (if you have admin privileges).
            </li>
        </ul>
        <p class="text-lm-text-secondary text-sm mt-4">
            You can always review these features by re-logging in or refreshing the page.
        </p>
        <div class="flex items-center justify-center mt-6">
            <input type="checkbox" id="dontShowPremiumAgain" class="mr-2 h-4 w-4 text-color-accent-blue rounded focus:ring-color-accent-blue bg-lm-input-bg border-lm-input-border" aria-label="Don't show premium welcome again">
            <label for="dontShowPremiumAgain" class="text-lm-text-secondary">Don't show this again</label>
        </div>
        <button id="closePremiumWelcomeModalButton" class="scan-button mt-6 w-full max-w-xs mx-auto" aria-label="Got It!">Got It!</button>
    </div>
</div>

<!-- Onboarding Modal -->
<div id="onboardingModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="onboardingModalTitle">
    <div class="modal-content max-w-xl">
        <span class="close-button" id="closeOnboardingModal" aria-label="Close Onboarding Modal">&times;</span>
        <h3 id="onboardingModalTitle" class="text-3xl font-bold text-color-accent-blue text-center mb-4">Welcome to Crypto OB Scanner!</h3>
        <div id="onboardingContent">
            <!-- Onboarding steps will be injected here -->
        </div>
        <div class="flex justify-between mt-6">
            <button id="onboardingPrev" class="action-button hidden" aria-label="Previous Onboarding Step">Previous</button>
            <button id="onboardingNext" class="scan-button ml-auto" aria-label="Next Onboarding Step">Next</button>
            <button id="onboardingFinish" class="scan-button hidden ml-auto" aria-label="Finish Onboarding">Got It!</button>
        </div>
    </div>
</div>


<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.umd.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script> <!-- AOS JS -->
<script>
    // Initialize AOS
    AOS.init({
        duration: 800,
        once: true,
        mirror: false,
    });

    // --- Configuration ---
    const API_BASE_URL ="https://api.obscanner.space/api"; // Your backend API URL - PRESERVED

    // --- DOM Elements (Authentication) ---
    const authSection = document.getElementById('authSection');
    const scannerSection = document.getElementById('scannerSection');
    const authForm = document.getElementById('authForm');
    const authFormTitle = document.getElementById('authFormTitle');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const emailGroup = document.getElementById('emailGroup');
    const emailInput = document.getElementById('email');
    const planGroup = document.getElementById('planGroup');
    const planSelect = document.getElementById('plan');
    const authSubmitButton = document.getElementById('authSubmitButton');
    const toggleAuthModeButton = document.getElementById('toggleAuthMode');
    const logoutButton = document.getElementById('logoutButton');

    // --- DOM Elements (Scanner) ---
    const scanButton = document.getElementById('scanButton');
    const clearButton = document.getElementById('clearButton');
    const showAllButton = document.getElementById('showAllButton');
    const showBuyingButton = document.getElementById('showBuyingButton');
    const showSellingButton = document.getElementById('showSellingButton');
    // NEW Timeframe Buttons
    const timeframe15mButton = document.getElementById('timeframe15mButton');
    const timeframe30mButton = document.getElementById('timeframe30mButton');
    const timeframe1hButton = document.getElementById('timeframe1hButton');
    const timeframe4hButton = document.getElementById('timeframe4hButton');
    const timeframe1dButton = document.getElementById('timeframe1dButton');
    const spinner = document.getElementById('spinner');
    const buttonText = document.getElementById('buttonText');
    const resultsContainer = document.getElementById('resultsContainer');
    const sensitivityButtons = document.querySelectorAll('.sensitivity-button');
    const priceDeviationInput = document.getElementById('priceDeviation');
    const priceDeviationValueSpan = document.getElementById('priceDeviationValue');


    // Modal elements
    const chartModal = document.getElementById('chartModal');
    const closeModalButton = document.getElementById('closeModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalOBInfo = document.getElementById('modalOBInfo');
    const lightweightChartContainer = document.getElementById('lightweightChartContainer');

    // Payment Modal elements
    const paymentModal = document.getElementById('paymentModal');
    const closePaymentModalButton = document.getElementById('closePaymentModal');
    const paymentProofForm = document.getElementById('paymentProofForm');
    const transactionHashInput = document.getElementById('transactionHash');
    const submitPaymentProofButton = document.getElementById('submitPaymentProofButton');

    // Admin Panel elements
    const adminPanelButton = document.getElementById('adminPanelButton');
    const adminPanelModal = document.getElementById('adminPanelModal');
    const closeAdminPanelModalButton = document.getElementById('closeAdminPanelModal');
    const userTableBody = document.getElementById('userTableBody');

    // Premium Welcome Modal elements
    const premiumWelcomeModal = document.getElementById('premiumWelcomeModal');
    const closePremiumWelcomeModalButton = document.getElementById('closePremiumWelcomeModalButton');
    const closePremiumWelcomeModalX = document.getElementById('closePremiumWelcomeModal');
    const dontShowPremiumAgainCheckbox = document.getElementById('dontShowPremiumAgain');

    // Theme Toggle elements
    const themeToggle = document.getElementById('themeToggle');
    const sunIcon = themeToggle.querySelector('.sun-icon');
    const moonIcon = themeToggle.querySelector('.moon-icon');

    // FAB elements for mobile
    const fabContainer = document.querySelector('.fab-container'); // Get the container for click outside logic
    const fabToggle = document.getElementById('fabToggle');
    const fabMenu = document.getElementById('fabMenu');
    const fabScanButton = document.getElementById('fabScanButton');
    const fabClearButton = document.getElementById('fabClearButton');
    const fabAdminButton = document.getElementById('fabAdminButton');
    const fabPaymentButton = document.getElementById('fabPaymentButton');
    const fabLogoutButton = document.getElementById('fabLogoutButton');

    // Onboarding Modal elements
    const onboardingModal = document.getElementById('onboardingModal');
    const closeOnboardingModalButton = document.getElementById('closeOnboardingModal');
    const onboardingContent = document.getElementById('onboardingContent');
    const onboardingPrevButton = document.getElementById('onboardingPrev');
    const onboardingNextButton = document.getElementById('onboardingNext');
    const onboardingFinishButton = document.getElementById('onboardingFinish');

    let allScanResults = [];
    let currentFilter = localStorage.getItem('currentFilter') || 'All';
    let currentTimeframe = localStorage.getItem('currentTimeframe') || '4h';
    let currentSensitivity = localStorage.getItem('currentSensitivity') || 'mid';
    let maxPriceDeviationPercent = parseFloat(localStorage.getItem('maxPriceDeviationPercent')) || 20;
    let isRegisterMode = false;
    let isAdminRegisterMode = false;
    let currentOnboardingStep = 0;

    // Predefined parameter presets for different sensitivities
    // 'requireUnmitigated' parameter removed as it's now always enforced in the backend.
    const sensitivityPresets = {
      'lowest': { minBodyRatio: 0.005, minPriceChange: 0.00001, volumeFactor: 0.05, requireBOS: false, requireC3ClosePastC2: false, requireFVG: false, minFvgDepthRatio: 0.005, description: "Broadest detection, high noise." },
      'low-mid': { minBodyRatio: 0.015, minPriceChange: 0.00005, volumeFactor: 0.1, requireBOS: true, requireC3ClosePastC2: true, requireFVG: false, minFvgDepthRatio: 0.01, description: "Balanced, less noise, some BOS/C3." },
      'mid': { minBodyRatio: 0.03, minPriceChange: 0.0001, volumeFactor: 0.2, requireBOS: true, requireC3ClosePastC2: true, requireFVG: true, minFvgDepthRatio: 0.02, description: "Standard, good balance of criteria." },
      'mid-high': { minBodyRatio: 0.05, minPriceChange: 0.0002, volumeFactor: 0.4, requireBOS: true, requireC3ClosePastC2: true, requireFVG: true, minFvgDepthRatio: 0.03, description: "Stricter, higher conviction setups." },
      'high': { minBodyRatio: 0.07, minPriceChange: 0.0005, volumeFactor: 0.6, requireBOS: true, requireC3ClosePastC2: true, requireFVG: true, minFvgDepthRatio: 0.05, description: "Very strict, high quality signals." },
      'extreme': { minBodyRatio: 0.10, minPriceChange: 0.001, volumeFactor: 0.8, requireBOS: true, requireC3ClosePastC2: true, requireFVG: true, minFvgDepthRatio: 0.08, description: "Most stringent, rare, strong signals." }
    };

    // Onboarding steps content
    const onboardingSteps = [
        {
            title: "Welcome to Crypto OB Scanner!",
            content: `
                <p class="text-lm-text-secondary mb-4">Discover powerful Order Blocks in cryptocurrency markets.</p>
                <ul class="text-lg text-lm-text-primary mb-6">
                    <li><i class="fas fa-search text-color-green-accent mr-2"></i> Scan for Buying & Selling Order Blocks.</li>
                    <li><i class="fas fa-chart-line text-color-green-accent mr-2"></i> Visualize OBs directly on interactive charts.</li>
                    <li><i class="fas fa-cogs text-color-green-accent mr-2"></i> Customize scan sensitivity and filters.</li>
                </ul>
                <p class="text-lm-text-secondary text-sm">Let's get you started!</p>
            `
        },
        {
            title: "Understanding Order Blocks",
            content: `
                <p class="text-lm-text-secondary mb-4">Order Blocks (OBs) are specific price areas where large institutional orders likely reside, often leading to significant price reactions.</p>
                <ul class="text-lg text-lm-text-primary mb-6">
                    <li><i class="fas fa-arrow-alt-circle-up text-color-green-accent mr-2"></i> <b>Buying (Bullish) OBs:</b> Areas where price might bounce up.</li>
                    <li><i class="fas fa-arrow-alt-circle-down text-color-red-accent mr-2"></i> <b>Selling (Bearish) OBs:</b> Areas where price might drop down.</li>
                </ul>
                <p class="text-lm-text-secondary text-sm">Our scanner helps you find these key zones.</p>
            `
        },
        {
            title: "How to Use the Scanner",
            content: `
                <p class="text-lm-text-secondary mb-4">It's simple to find your next trade opportunity:</p>
                <ul class="text-lg text-lm-text-primary mb-6">
                    <li><i class="fas fa-clock text-color-green-accent mr-2"></i> Select your desired <b>Timeframe</b> (e.g., 4H, 1D).</li>
                    <li><i class="fas fa-sliders-h text-color-green-accent mr-2"></i> Adjust <b>Detection Sensitivity</b> for more or fewer results.</li>
                    <li><i class="fas fa-filter text-color-green-accent mr-2"></i> Use the <b>Filter</b> buttons to narrow down to Buying or Selling OBs.</li>
                    <li><i class="fas fa-play-circle text-color-green-accent mr-2"></i> Click <b>"Initiate Scan"</b> to get real-time data!</li>
                </ul>
                <p class="text-lm-text-secondary text-sm">Click on any coin card to see its chart!</p>
            `
        },
        {
            title: "Chart Visualizations & Trade Setups",
            content: `
                <p class="text-lm-text-secondary mb-4">When you click a coin card, you'll see a detailed chart:</p>
                <ul class="text-lg text-lm-text-primary mb-6">
                    <li><i class="fas fa-square text-color-accent-purple mr-2"></i> Detected Order Block zones are highlighted.</li>
                    <li><i class="fas fa-money-bill-wave text-color-green-accent mr-2"></i> Suggested Entry, Stop Loss, and Take Profit levels are plotted.</li>
                    <li><i class="fas fa-chart-area text-color-green-accent mr-2"></i> Use these visual aids to plan your trades more effectively.</li>
                </ul>
                <p class="text-lm-text-secondary text-sm">Happy trading!</p>
            `
        }
    ];

    // Skeleton card HTML
    const skeletonCardHTML = `
        <div class="glass-container" data-aos="fade-up">
            <div class="skeleton-card">
                <div class="skeleton-line long"></div>
                <div class="skeleton-line medium"></div>
                <div class="skeleton-line short"></div>
                <div class="mt-4 pt-4 border-t border-lm-border">
                    <div class="skeleton-line medium"></div>
                    <div class="skeleton-line short"></div>
                    <div class="skeleton-line long"></div>
                </div>
            </div>
        </div>
    `;

    // --- Helper Functions (Independent or Low-Dependency) ---

    // Toast Notification System
    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.classList.add('toast', type);
        toast.innerHTML = `
            ${type === 'success' ? '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' : ''}
            ${type === 'error' ? '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' : ''}
            ${type === 'info' ? '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' : ''}
            <span>${message}</span>
        `;
        toastContainer.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, duration);
    }

    // Modal Management (Unified Functions)
    function openModal(modalElement) {
        modalElement.classList.remove('hidden');
        // Force reflow to ensure transition plays
        void modalElement.offsetWidth;
        modalElement.classList.add('show');
    }

    function closeModal(modalElement) {
        modalElement.classList.remove('show');
        modalElement.addEventListener('transitionend', function handler() {
            modalElement.classList.add('hidden');
            modalElement.removeEventListener('transitionend', handler);
        }, { once: true }); // Use once: true to ensure it only runs once
    }

    function formatPrice(price) {
        if (price === null || price === undefined) return 'N/A';
        // Use toFixed to ensure consistent decimal places for display,
        // but parseFloat to remove trailing zeros if not needed for precision.
        // For crypto, often more decimals are needed.
        return parseFloat(price).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 8 });
    }

    function formatPercentage(value) {
        if (value === null || value === undefined) return 'N/A';
        return `${(value * 100).toFixed(2)}%`;
    }

    // Mock function to generate candlestick data for Lightweight Charts
    // In a real application, this would fetch from a data provider
    function generateMockCandleData(numDays, currentPrice) {
        const data = [];
        let lastClose = currentPrice * 0.95 + (Math.random() * currentPrice * 0.1); // Start price
        let lastTime = Date.now() / 1000 - numDays * 24 * 60 * 60; // Start 'numDays' ago

        for (let i = 0; i < numDays; i++) {
            const open = lastClose;
            const high = open * (1 + Math.random() * 0.02);
            const low = open * (1 - Math.random() * 0.02);
            const close = open + (Math.random() - 0.5) * open * 0.03;

            data.push({
                time: lastTime + i * 24 * 60 * 60, // Daily candles
                open: open,
                high: high,
                low: low,
                close: close
            });
            lastClose = close;
        }

        // Ensure the current price is somewhat near the end of the data
        const latestCandle = data[data.length - 1];
        if (latestCandle) {
            latestCandle.close = currentPrice;
            latestCandle.high = Math.max(latestCandle.high, currentPrice);
            latestCandle.low = Math.min(latestCandle.low, currentPrice);
            latestCandle.open = latestCandle.open; // Keep open relative
        }

        return data;
    }


    // --- Core Logic Functions (Higher-Dependency) ---

    // Theme Management
    function applyTheme(theme) {
        // For this theme, we want it to always be 'dark' visually
        // So we ensure the 'dark' class is always present
        document.documentElement.classList.add('dark');
        sunIcon.style.display = 'block'; // Show sun icon (indicating it's dark mode)
        moonIcon.style.display = 'none'; // Hide moon icon

        localStorage.setItem('theme', 'dark'); // Force save 'dark' theme

        // Update chart theme if chart is open
        if (window.currentChart) {
            window.currentChart.applyOptions({
                layout: {
                    textColor: 'var(--color-text-light)',
                    background: { color: 'var(--color-dark-bg-primary)' },
                },
                grid: {
                    vertLines: { color: 'var(--color-border-dark)' },
                    horzLines: { color: 'var(--color-border-dark)' },
                },
                timeScale: {
                    borderColor: 'var(--color-border-dark)',
                },
                priceScale: {
                    borderColor: 'var(--color-border-dark)',
                }
            });
        }
    }

    function toggleTheme() {
        // Since this theme is always dark, the toggle will just re-apply dark
        // or could be removed if no light mode functionality is desired.
        // For now, it will just ensure dark mode is active.
        applyTheme('dark');
        showToast("This theme is optimized for dark mode.", 'info');
    }

    // Function to update sensitivity tooltips
    function updateSensitivityTooltips() {
        sensitivityButtons.forEach(button => {
            const sensitivityType = button.dataset.sensitivity;
            const preset = sensitivityPresets[sensitivityType];
            const tooltipId = `tooltip-${sensitivityType}`;
            const tooltipElement = document.getElementById(tooltipId);
            if (tooltipElement && preset) {
                tooltipElement.innerHTML = `
                    <b>${sensitivityType.replace('-', ' ').toUpperCase()}</b><br>
                    ${preset.description}<br>
                    Min Body Ratio: ${preset.minBodyRatio}<br>
                    Min Price Change: ${preset.minPriceChange}<br>
                    Volume Factor: ${preset.volumeFactor}<br>
                    Require BOS: ${preset.requireBOS ? 'Yes' : 'No'}<br>
                    Require C3 Close Past C2: ${preset.requireC3ClosePastC2 ? 'Yes' : 'No'}<br>
                    Require FVG: ${preset.requireFVG ? 'Yes' : 'No'}<br>
                    Min FVG Depth Ratio: ${preset.minFvgDepthRatio}
                `;
            }
        });
    }

    function displayResults(resultsToDisplay, actualTimeframeUsed) {
        resultsContainer.innerHTML = '';

        // Filter based on the main filter (All, Buying, Selling)
        let filteredByMainType = [];
        if (currentFilter === 'All') {
            filteredByMainType = resultsToDisplay;
        } else {
            // If filtering by Buying/Selling, we need to check if ANY of the coin's order blocks match
            filteredByMainType = resultsToDisplay.filter(coin =>
                coin.orderBlocks.some(ob => ob.obType === currentFilter)
            );
        }

        // Further filter by price deviation for each individual order block
        let finalFilteredResults = [];
        filteredByMainType.forEach(coin => {
            const filteredOrderBlocks = coin.orderBlocks.filter(ob => {
                // 'None' type order blocks or those without price are always shown (e.g., if no OBs detected)
                if (ob.obType === 'None' || ob.obPrice === null || ob.obPrice === undefined) {
                    return true;
                }
                const priceDiff = Math.abs(ob.obPrice - coin.currentPrice);
                const percentageDiff = (priceDiff / coin.currentPrice) * 100;
                return percentageDiff <= maxPriceDeviationPercent;
            });

            // Only add the coin to final results if it has at least one order block after deviation filtering
            if (filteredOrderBlocks.length > 0) {
                // Create a new coin object with only the filtered order blocks
                finalFilteredResults.push({ ...coin, orderBlocks: filteredOrderBlocks });
            }
        });


        if (finalFilteredResults.length === 0) {
            resultsContainer.innerHTML = `
                <p class="text-center text-lm-text-secondary col-span-full py-8">
                    No order block data available for current filters.
                    <br>Try adjusting sensitivity, price deviation, or timeframe, then click "Initiate Scan" again.
                </p>
            `;
            return;
        }

        finalFilteredResults.forEach((coin, index) => {
            // Determine the main card border color based on if any Buying/Selling OBs are present
            let cardBorderClass = 'no-ob-border';
            let obTypeIcon = '';
            let obTypeText = ''; // For the data-text attribute
            if (coin.orderBlocks.some(ob => ob.obType === 'Buying (Bullish)')) {
                cardBorderClass = 'buying-ob-border';
                obTypeIcon = '<i class="fas fa-arrow-alt-circle-up text-color-green-accent mr-1"></i>';
                obTypeText = 'Buying OB';
            } else if (coin.orderBlocks.some(ob => ob.obType === 'Selling (Bearish)')) {
                cardBorderClass = 'selling-ob-border';
                obTypeIcon = '<i class="fas fa-arrow-alt-circle-down text-color-red-accent mr-1"></i>';
                obTypeText = 'Selling OB';
            } else {
                obTypeText = 'No OB Detected';
            }

            const currentPriceDisplay = formatPrice(coin.currentPrice);
            const priceChange24h = coin.priceChange24h ? formatPercentage(coin.priceChange24h) : 'N/A';
            const priceChangeClass = coin.priceChange24h > 0 ? 'text-color-green-accent' : coin.priceChange24h < 0 ? 'text-color-red-accent' : 'text-lm-text-secondary';


            let orderBlocksHtml = '';
            // Sort order blocks by price to display them consistently (e.g., lowest price first)
            const sortedOrderBlocks = [...coin.orderBlocks].sort((a, b) => {
                if (a.obPrice === null) return 1; // 'None' or null prices go to end
                if (b.obPrice === null) return -1;
                return a.obPrice - b.obPrice;
            });


            sortedOrderBlocks.forEach((ob, obIndex) => {
                const obPriceDisplay = formatPrice(ob.obPrice);
                const obZoneInfo = (ob.obType !== 'None' && ob.obZoneStart !== null && ob.obZoneEnd !== null) ?
                                   ` | Zone: $${formatPrice(ob.obZoneStart)} - $${formatPrice(ob.obZoneEnd)}` : '';
                const obTypeClass = ob.obType === 'Buying (Bullish)' ? 'text-color-green-accent' :
                                    ob.obType === 'Selling (Bearish)' ? 'text-color-red-accent' :
                                    'text-lm-text-secondary';
                const obIcon = ob.obType === 'Buying (Bullish)' ? '<i class="fas fa-arrow-alt-circle-up mr-1"></i>' :
                               ob.obType === 'Selling (Bearish)' ? '<i class="fas fa-arrow-alt-circle-down mr-1"></i>' : '';

                let tradeSetupHtml = '';
                if (ob.suggestedEntryPrice !== null && ob.suggestedEntryPrice !== undefined) {
                    tradeSetupHtml = `
                        <div class="mt-2 text-xs text-lm-text-secondary border-t border-lm-border pt-2">
                            <p>Entry: <span class="font-bold text-lm-text-primary">$${formatPrice(ob.suggestedEntryPrice)}</span></p>
                            <p>Stop Loss: <span class="font-bold text-color-red-accent">$${formatPrice(ob.suggestedStopLoss)}</span> (Risk: $${formatPrice(ob.riskAmount)})</p>
                            ${ob.suggestedTakeProfits && ob.suggestedTakeProfits.TP1 !== null && ob.suggestedTakeProfits.TP1 !== undefined ? `<p>TP1 (1R): <span class="font-bold text-color-green-accent">$${formatPrice(ob.suggestedTakeProfits.TP1)}</span></p>` : ''}
                            ${ob.suggestedTakeProfits && ob.suggestedTakeProfits.TP2 !== null && ob.suggestedTakeProfits.TP2 !== undefined ? `<p>TP2 (2R): <span class="font-bold text-color-green-accent">$${formatPrice(ob.suggestedTakeProfits.TP2)}</span></p>` : ''}
                            ${ob.suggestedTakeProfits && ob.suggestedTakeProfits.TP3 !== null && ob.suggestedTakeProfits.TP3 !== undefined ? `<p>TP3 (3R): <span class="font-bold text-color-green-accent">$${formatPrice(ob.suggestedTakeProfits.TP3)}</span></p>` : ''}
                            ${ob.suggestedTakeProfits && ob.suggestedTakeProfits.TP4 !== null && ob.suggestedTakeProfits.TP4 !== undefined ? `<p>TP4 (4R): <span class="font-bold text-color-green-accent">$${formatPrice(ob.suggestedTakeProfits.TP4)}</span></p>` : ''}
                            ${ob.suggestedTakeProfits && ob.suggestedTakeProfits.TP5 !== null && ob.suggestedTakeProfits.TP5 !== undefined ? `<p>TP5 (5R): <span class="font-bold text-color-green-accent">$${formatPrice(ob.suggestedTakeProfits.TP5)}</span></p>` : ''}
                        </div>
                    `;
                }


                orderBlocksHtml += `
                    <div class="mt-3 pt-3 ${obIndex > 0 ? 'border-t border-lm-border' : ''}">
                        <p class="text-md font-semibold mb-1">
                            Order Block ${obIndex + 1}: <span class="${obTypeClass}">${obIcon}${ob.obType || 'N/A'}</span>
                        </p>
                        <p class="text-lm-text-secondary text-sm mb-1">
                            Price Level: <span class="text-lm-text-primary font-bold">$${obPriceDisplay}</span>${obZoneInfo}
                        </p>
                        <p class="text-lm-text-secondary text-xs">${ob.details || 'No additional details.'}</p>
                        ${tradeSetupHtml}
                    </div>
                `;
            });

            resultsContainer.innerHTML += `
                <div class="glass-container"
                     data-aos="fade-up" data-aos-delay="${index * 100}">
                    <div class="glass-card ${cardBorderClass}"
                         data-symbol="${coin.id}"
                         data-timeframe="${coin.timeframe}"
                         data-coin-name="${coin.name}"
                         data-current-price="${coin.currentPrice}"
                         data-order-blocks='${JSON.stringify(coin.orderBlocks)}'
                         data-text="${coin.name} (${coin.id}) - ${obTypeText}">
                        <div class="content">
                            <h2 class="text-2xl font-bold tracking-wide">${coin.name || 'N/A'} (${coin.id || 'N/A'})</h2>
                            <p class="text-lg font-semibold">Vol: ${coin.volume || 'N/A'}</p>
                            <p>Current Price: <span class="font-medium">$${currentPriceDisplay}</span></p>
                            <p>24h Change: <span class="${priceChangeClass} font-medium">${priceChange24h}</span></p>
                            <p>Scan Time: <span class="font-medium">${coin.timestamp || 'N/A'}</span></p>
                            <p>Timeframe: <span class="font-medium">${(coin.timeframe || 'N/A').toUpperCase()}</span></p>
                            <div class="ob-details">
                                ${orderBlocksHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        document.querySelectorAll('.glass-card').forEach(card => {
            card.addEventListener('click', openChartModal);
        });
        // Update toast message to reflect actual timeframe used
        showToast(`Scan complete! Found ${finalFilteredResults.length} coins for ${actualTimeframeUsed.toUpperCase()} timeframe with "${currentSensitivity}" sensitivity. Displaying results after price deviation filter.`, 'success');
    }

    function filterResults() {
        let filtered = [];
        if (currentFilter === 'All') {
            filtered = allScanResults;
        } else {
            filtered = allScanResults.filter(coin =>
                coin.orderBlocks.some(ob => ob.obType === currentFilter)
            );
        }
        // When filtering, we don't change the 'actualTimeframeUsed' as it refers to the scan.
        // So, we pass the original `currentTimeframe` for display consistency in the toast.
        displayResults(filtered, allScanResults.length > 0 ? allScanResults[0].timeframe : currentTimeframe);
    }

    function setFilter(filterType) {
        currentFilter = filterType;
        localStorage.setItem('currentFilter', filterType);
        document.querySelectorAll('.action-button[data-filter]').forEach(btn => {
            if (btn.dataset.filter === filterType) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        filterResults();
    }

    function setTimeframe(timeframe) {
        currentTimeframe = timeframe;
        localStorage.setItem('currentTimeframe', timeframe);
        document.querySelectorAll('.action-button[data-timeframe]').forEach(btn => {
            if (btn.dataset.timeframe === timeframe) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        showToast(`Starting timeframe set to ${currentTimeframe.toUpperCase()}. Click Scan to update results.`, 'info');
    }

    function setSensitivity(sensitivityType) {
      currentSensitivity = sensitivityType;
      localStorage.setItem('currentSensitivity', sensitivityType);
      sensitivityButtons.forEach(btn => {
        if (btn.dataset.sensitivity === sensitivityType) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      showToast(`Detection sensitivity set to "${sensitivityType}". Click Scan to update results.`, 'info');
    }

    function clearResults() {
        allScanResults = [];
        currentFilter = 'All';
        localStorage.setItem('currentFilter', 'All');
        setFilter('All');
        resultsContainer.innerHTML = '<p class="text-center text-lm-text-secondary col-span-full py-8">Results cleared. Click "Initiate Scan" to begin analyzing market data.</p>';
        showToast('Results cleared.', 'info');
    }

    // Chart Modal Functions
    function openChartModal(event) {
      const card = event.currentTarget;
      const symbol = card.dataset.symbol;
      const timeframe = card.dataset.timeframe;
      const coinName = card.dataset.coinName;
      const currentPrice = parseFloat(card.dataset.currentPrice);
      const allOrderBlocks = JSON.parse(card.dataset.orderBlocks || '[]'); // Corrected data attribute name

      modalTitle.textContent = `${coinName} (${symbol}) Chart - ${timeframe.toUpperCase()}`;

      let obInfoHtml = '';
      const displayableOrderBlocks = allOrderBlocks.filter(ob => ob.obType !== 'None' && ob.obPrice !== null && ob.obPrice !== undefined);

      if (displayableOrderBlocks.length > 0) {
          const sortedModalOrderBlocks = [...displayableOrderBlocks].sort((a, b) => {
              return a.obPrice - b.obPrice;
          });

          obInfoHtml = sortedModalOrderBlocks.map((ob, index) => {
              const obPriceDisplay = formatPrice(ob.obPrice);
              const obZoneInfo = (ob.obZoneStart !== null && ob.obZoneEnd !== null) ?
                                 ` | Zone: $${formatPrice(ob.obZoneStart)} - $${formatPrice(ob.obZoneEnd)}` : '';
              const obTypeClass = ob.obType === 'Buying (Bullish)' ? 'text-color-green-accent' :
                                  ob.obType === 'Selling (Bearish)' ? 'text-color-red-accent' : '';
              const obIcon = ob.obType === 'Buying (Bullish)' ? '<i class="fas fa-arrow-alt-circle-up mr-1"></i>' :
                             ob.obType === 'Selling (Bearish)' ? '<i class="fas fa-arrow-alt-circle-down mr-1"></i>' : '';

              let tradeSetupModalHtml = '';
              if (ob.suggestedEntryPrice !== null && ob.suggestedEntryPrice !== undefined) {
                  tradeSetupModalHtml = `
                      <div class="mt-2 text-xs text-lm-text-secondary border-t border-lm-border pt-2">
                          <p>Entry: <span class="font-bold text-lm-text-primary">$${formatPrice(ob.suggestedEntryPrice)}</span></p>
                          <p>Stop Loss: <span class="font-bold text-color-red-accent">$${formatPrice(ob.suggestedStopLoss)}</span> (Risk: $${formatPrice(ob.riskAmount)})</p>
                          ${ob.suggestedTakeProfits && ob.suggestedTakeProfits.TP1 !== null && ob.suggestedTakeProfits.TP1 !== undefined ? `<p>TP1 (1R): <span class="font-bold text-color-green-accent">$${formatPrice(ob.suggestedTakeProfits.TP1)}</span></p>` : ''}
                          ${ob.suggestedTakeProfits && ob.suggestedTakeProfits.TP2 !== null && ob.suggestedTakeProfits.TP2 !== undefined ? `<p>TP2 (2R): <span class="font-bold text-color-green-accent">$${formatPrice(ob.suggestedTakeProfits.TP2)}</span></p>` : ''}
                          ${ob.suggestedTakeProfits && ob.suggestedTakeProfits.TP3 !== null && ob.suggestedTakeProfits.TP3 !== undefined ? `<p>TP3 (3R): <span class="font-bold text-color-green-accent">$${formatPrice(ob.suggestedTakeProfits.TP3)}</span></p>` : ''}
                          ${ob.suggestedTakeProfits && ob.suggestedTakeProfits.TP4 !== null && ob.suggestedTakeProfits.TP4 !== undefined ? `<p>TP4 (4R): <span class="font-bold text-color-green-accent">$${formatPrice(ob.suggestedTakeProfits.TP4)}</span></p>` : ''}
                          ${ob.suggestedTakeProfits && ob.suggestedTakeProfits.TP5 !== null && ob.suggestedTakeProfits.TP5 !== undefined ? `<p>TP5 (5R): <span class="font-bold text-color-green-accent">$${formatPrice(ob.suggestedTakeProfits.TP5)}</span></p>` : ''}
                      </div>
                  `;
              }

              return `
                  <p class="text-center text-lm-text-secondary text-sm">
                      OB ${index + 1}: <span class="${obTypeClass}">${obIcon}${ob.obType || 'N/A'}</span> | Price Level: <span class="text-lm-text-primary font-bold">$${obPriceDisplay}</span>${obZoneInfo}
                  </p>
                  ${tradeSetupModalHtml}
              `;
          }).join('');
      } else {
          obInfoHtml = '<p class="text-center text-lm-text-secondary text-sm">No valid order blocks found for this coin with current criteria.</p>';
      }
      modalOBInfo.innerHTML = obInfoHtml;

      // Clear previous chart if any
      lightweightChartContainer.innerHTML = '';
      if (window.currentChart) {
          window.currentChart.remove();
          window.currentChart = null;
      }

      // Initialize Lightweight Charts
      const chartOptions = {
          layout: {
              textColor: document.documentElement.classList.contains('dark') ? 'var(--color-text-light)' : 'var(--lm-text-primary)',
              background: { color: document.documentElement.classList.contains('dark') ? 'var(--color-dark-bg-primary)' : 'var(--lm-bg-secondary)' },
          },
          grid: {
              vertLines: { color: document.documentElement.classList.contains('dark') ? 'var(--color-border-dark)' : 'var(--lm-border)' },
              horzLines: { color: document.documentElement.classList.contains('dark') ? 'var(--color-border-dark)' : 'var(--lm-border)' },
          },
          timeScale: {
              borderColor: document.documentElement.classList.contains('dark') ? 'var(--color-border-dark)' : 'var(--lm-border)',
              timeVisible: true,
              secondsVisible: false,
          },
          priceScale: {
              borderColor: document.documentElement.classList.contains('dark') ? 'var(--color-border-dark)' : 'var(--lm-border)',
          },
          crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
          },
          localization: {
            locale: 'en-US',
            priceFormatter: price => formatPrice(price),
          }
      };

      const chart = LightweightCharts.createChart(lightweightChartContainer, chartOptions);
      window.currentChart = chart; // Store chart instance globally for theme changes

      const candlestickSeries = chart.addCandlestickSeries({
          upColor: 'var(--color-green-accent)',
          downColor: 'var(--color-red-accent)',
          borderVisible: false,
          wickColor: 'var(--color-text-secondary)',
          wickUpColor: 'var(--color-green-accent)',
          wickDownColor: 'var(--color-red-accent)',
      });

      // Generate mock data for the chart
      const mockData = generateMockCandleData(100, currentPrice); // 100 days of data
      candlestickSeries.setData(mockData);

      // Add horizontal lines for OB price levels and trade setups
      displayableOrderBlocks.forEach(ob => {
          if (ob.obPrice) {
              const obPriceLine = chart.addLineSeries({
                  color: ob.obType === 'Buying (Bullish)' ? 'var(--color-green-accent)' : 'var(--color-red-accent)',
                  lineWidth: 2,
                  lineStyle: LightweightCharts.LineStyle.Dotted,
                  axisLabelVisible: true,
                  title: `${ob.obType.split(' ')[0]} OB`,
              });
              obPriceLine.setData([{ time: mockData[0].time, value: ob.obPrice }, { time: mockData[mockData.length - 1].time, value: ob.obPrice }]);
          }

          // Draw OB zone as a shaded area (if zone exists)
          if (ob.obZoneStart && ob.obZoneEnd) {
              // Lightweight Charts doesn't have a direct "rectangle" drawing for price zones.
              // A workaround is to use bands or custom series. For simplicity, we'll draw two lines for the zone.
              const obZoneStartLine = chart.addLineSeries({
                  color: ob.obType === 'Buying (Bullish)' ? 'var(--color-green-accent)' : 'var(--color-red-accent)',
                  lineWidth: 1,
                  lineStyle: LightweightCharts.LineStyle.Solid,
                  axisLabelVisible: false,
              });
              obZoneStartLine.setData([{ time: mockData[0].time, value: ob.obZoneStart }, { time: mockData[mockData.length - 1].time, value: ob.obZoneStart }]);

              const obZoneEndLine = chart.addLineSeries({
                  color: ob.obType === 'Buying (Bullish)' ? 'var(--color-green-accent)' : 'var(--color-red-accent)',
                  lineWidth: 1,
                  lineStyle: LightweightCharts.LineStyle.Solid,
                  axisLabelVisible: false,
              });
              obZoneEndLine.setData([{ time: mockData[0].time, value: ob.obZoneEnd }, { time: mockData[mockData.length - 1].time, value: ob.obZoneEnd }]);
          }

          // Plot Trade Setup Lines
          if (ob.suggestedEntryPrice) {
              const entryLine = chart.addLineSeries({ color: 'var(--color-accent-blue)', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Solid, axisLabelVisible: true, title: 'Entry' });
              entryLine.setData([{ time: mockData[0].time, value: ob.suggestedEntryPrice }, { time: mockData[mockData.length - 1].time, value: ob.suggestedEntryPrice }]);

              const stopLossLine = chart.addLineSeries({ color: 'var(--color-red-accent)', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Solid, axisLabelVisible: true, title: 'SL' });
              stopLossLine.setData([{ time: mockData[0].time, value: ob.suggestedStopLoss }, { time: mockData[mockData.length - 1].time, value: ob.suggestedStopLoss }]);

              // Plot TP lines from the suggestedTakeProfits map
              if (ob.suggestedTakeProfits) {
                  for (let i = 1; i <= 5; i++) {
                      const tpKey = `TP${i}`;
                      const tpValue = ob.suggestedTakeProfits[tpKey];
                      if (tpValue !== null && tpValue !== undefined) {
                          const tpLine = chart.addLineSeries({ color: 'var(--color-green-accent)', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Solid, axisLabelVisible: true, title: tpKey });
                          tpLine.setData([{ time: mockData[0].time, value: tpValue }, { time: mockData[mockData.length - 1].time, value: tpValue }]);
                      }
                  }
              }
          }
      });

      // Fit content to screen
      chart.timeScale().fitContent();

      openModal(chartModal);
    }

    function closeChartModal() {
      closeModal(chartModal);
      if (window.currentChart) {
          window.currentChart.remove(); // Dispose the chart instance
          window.currentChart = null;
      }
    }

    // Onboarding Modal Functions
    function showOnboardingModal() {
        currentOnboardingStep = 0;
        updateOnboardingContent();
        openModal(onboardingModal);
    }

    function updateOnboardingContent() {
        onboardingContent.innerHTML = onboardingSteps[currentOnboardingStep].content;

        onboardingPrevButton.classList.toggle('hidden', currentOnboardingStep === 0);
        onboardingNextButton.classList.toggle('hidden', currentOnboardingStep === onboardingSteps.length - 1);
        onboardingFinishButton.classList.toggle('hidden', currentOnboardingStep < onboardingSteps.length - 1);
    }

    function nextOnboardingStep() {
        if (currentOnboardingStep < onboardingSteps.length - 1) {
            currentOnboardingStep++;
            updateOnboardingContent();
        }
    }

    function prevOnboardingStep() {
        if (currentOnboardingStep > 0) {
            currentOnboardingStep--;
            updateOnboardingContent();
        }
    }

    function finishOnboarding() {
        localStorage.setItem('hasSeenOnboarding', 'true');
        closeModal(onboardingModal);
    }


    // Authentication Functions
    function showAuthSection() {
        authSection.style.display = 'flex'; // Ensure it's displayed as flex
        scannerSection.style.display = 'none'; // Ensure scanner is hidden
        closeModal(paymentModal);
        closeModal(adminPanelModal);
        closeModal(premiumWelcomeModal);
        closeModal(onboardingModal); // Close onboarding if open
        usernameInput.value = '';
        passwordInput.value = '';
        emailInput.value = '';
        localStorage.removeItem('jwtToken');
        localStorage.removeItem('username');
        localStorage.removeItem('roles');
        localStorage.removeItem('userId');
        logoutButton.classList.add('hidden'); // Hide main logout button
        adminPanelButton.classList.add('hidden'); // Hide admin button on logout
        // Reset auth form to login mode
        isRegisterMode = false;
        isAdminRegisterMode = false;
        authFormTitle.textContent = 'Login';
        authSubmitButton.textContent = 'Login';
        emailGroup.classList.add('hidden');
        planGroup.classList.add('hidden');
        toggleAuthModeButton.textContent = "Don't have an account? Register here.";
        updateFabAdminButtonVisibility(); // Update FAB visibility after logout
    }

    async function showScannerSection() {
        authSection.style.display = 'none'; // Hide auth section
        scannerSection.style.display = 'block'; // Show scanner section (as block for grid layout)
        closeModal(paymentModal);
        closeModal(adminPanelModal);
        closeModal(premiumWelcomeModal);
        closeModal(onboardingModal); // Close onboarding if open
        logoutButton.classList.remove('hidden'); // Show main logout button
        showToast(`Welcome, ${localStorage.getItem('username')}! Click "Initiate Scan" to begin analyzing market data.`, 'info');
        await fetchUserStatus();

        const userRoles = localStorage.getItem('roles') ? JSON.parse(localStorage.getItem('roles')) : [];
        const isPremiumOrTrial = userRoles.includes('ROLE_PREMIUM') || userRoles.includes('ROLE_TRIAL');
        const hasSeenPremiumWelcome = localStorage.getItem('hasSeenPremiumWelcome');
        const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');

        if (isPremiumOrTrial && hasSeenPremiumWelcome !== 'true') {
            openModal(premiumWelcomeModal);
        }

        if (hasSeenOnboarding !== 'true') {
            showOnboardingModal();
        }

        updateFabAdminButtonVisibility(); // Update FAB visibility after login
    }

    function showPaymentSection(registeredUsername) {
        authSection.style.display = 'none';
        scannerSection.style.display = 'none';
        closeModal(adminPanelModal);
        closeModal(premiumWelcomeModal);
        closeModal(onboardingModal); // Close onboarding if open
        openModal(paymentModal);
        transactionHashInput.value = '';
        localStorage.setItem('pendingPaymentUsername', registeredUsername);
    }

    async function showAdminPanel() {
        openModal(adminPanelModal);
        showToast('Loading users...', 'info', 1500); // Shorter toast for loading
        userTableBody.innerHTML = '';

        const token = localStorage.getItem('jwtToken');
        if (!token) {
            showToast("Authentication required to access admin panel.", 'error');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/admin/users`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                let errorData = {};
                try {
                    errorData = await response.json();
                } catch (e) {
                    errorData.message = `Non-JSON error response: ${response.status} ${response.statusText}`;
                }
                showToast(errorData.message || "Failed to fetch users. Please check your admin privileges.", 'error');
                return;
            }

            const users = await response.json();
            displayUsersInAdminPanel(users);
            showToast('Users loaded successfully!', 'success');

        } catch (error) {
            showToast(`Network error fetching users: ${error.message}. Please check your connection.`, 'error');
            console.error("Admin panel fetch error:", error);
        }
    }

    // Display users in admin panel table
    function displayUsersInAdminPanel(users) {
        userTableBody.innerHTML = '';
        if (users.length === 0) {
            userTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-lm-text-secondary">No users found.</td></tr>';
            return;
        }

        users.forEach(user => {
            const isPremium = user.isPremium ? 'Yes' : 'No';
            const trialActive = user.trialActive ? 'Yes' : 'No';
            const trialExpiry = user.trialExpiryDate ? new Date(user.trialExpiryDate).toLocaleDateString() : 'N/A';
            const roles = user.roles ? user.roles.join(', ') : 'N/A';

            userTableBody.innerHTML += `
                <tr class="user-table-row">
                    <td class="py-2 px-4">${user.username}</td>
                    <td class="py-2 px-4">${user.email}</td>
                    <td class="py-2 px-4">${isPremium}</td>
                    <td class="py-2 px-4">${trialActive}</td>
                    <td class="py-2 px-4 hidden sm:table-cell">${trialExpiry}</td>
                    <td class="py-2 px-4 hidden sm:table-cell text-sm text-lm-text-secondary">${roles}</td>
                    <td class="py-2 px-4">
                        <button class="action-button bg-color-green-accent hover:bg-color-green-accent text-white grant-premium-btn" data-username="${user.username}" ${user.isPremium ? 'disabled' : ''} aria-label="Grant Premium to ${user.username}"><i class="fas fa-check-circle mr-1"></i>Grant Premium</button>
                        <button class="action-button bg-color-red-accent hover:bg-color-red-light text-white revoke-premium-btn" data-username="${user.username}" ${!user.isPremium ? 'disabled' : ''} aria-label="Revoke Premium from ${user.username}"><i class="fas fa-times-circle mr-1"></i>Revoke Premium</button>
                        <button class="action-button bg-color-accent-blue hover:bg-color-accent-blue-dark text-white activate-trial-btn" data-username="${user.username}" ${user.trialActive ? 'disabled' : ''} aria-label="Activate 3-Day Trial for ${user.username}"><i class="fas fa-hourglass-half mr-1"></i>Activate 3-Day Trial</button>
                    </td>
                </tr>
            `;
        });

        // Add event listeners to the action buttons
        document.querySelectorAll('.grant-premium-btn').forEach(button => {
            button.addEventListener('click', (e) => grantPremium(e.target.dataset.username));
        });
        document.querySelectorAll('.revoke-premium-btn').forEach(button => {
            button.addEventListener('click', (e) => revokePremium(e.target.dataset.username));
        });
        document.querySelectorAll('.activate-trial-btn').forEach(button => {
            button.addEventListener('click', (e) => activateTrial(e.target.dataset.username));
        });
    }

    // Admin Actions
    async function grantPremium(username) {
        showToast(`Granting premium to ${username}...`, 'info');
        const token = localStorage.getItem('jwtToken');
        try {
            const response = await fetch(`${API_BASE_URL}/admin/grant-premium/${username}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.ok) {
                showToast(data.message || `Premium granted to ${username} successfully!`, 'success');
                showAdminPanel(); // Refresh user list
            } else {
                showToast(data.message || `Failed to grant premium to ${username}. Please try again.`, 'error');
            }
        } catch (error) {
            showToast(`Network error: ${error.message}. Please check your connection.`, 'error');
        }
    }

    async function revokePremium(username) {
        showToast(`Revoking premium from ${username}...`, 'info');
        const token = localStorage.getItem('jwtToken');
        try {
            const response = await fetch(`${API_BASE_URL}/admin/revoke-premium/${username}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.ok) {
                showToast(data.message || `Premium revoked from ${username} successfully!`, 'success');
                showAdminPanel(); // Refresh user list
            } else {
                showToast(data.message || `Failed to revoke premium from ${username}. Please try again.`, 'error');
            }
        } catch (error) {
            showToast(`Network error: ${error.message}. Please check your connection.`, 'error');
        }
        }

    async function activateTrial(username) {
        showToast(`Activating trial for ${username}...`, 'info');
        const token = localStorage.getItem('jwtToken');
        try {
            const response = await fetch(`${API_BASE_URL}/admin/activate-trial/${username}/3`, { // 3 days for trial
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.ok) {
                showToast(data.message || `3-day trial activated for ${username} successfully!`, 'success');
                showAdminPanel(); // Refresh user list
            } else {
                showToast(data.message || `Failed to activate trial for ${username}. Please try again.`, 'error');
            }
        } catch (error) {
            showToast(`Network error: ${error.message}. Please check your connection.`, 'error');
        }
    }


    async function fetchUserStatus() {
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/user/status`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                let errorData = {};
                try {
                    errorData = await response.json();
                } catch (e) {
                    errorData.message = `Non-JSON error response: ${response.status} ${response.statusText}`;
                }
                if (response.status === 401 || response.status === 403) {
                    showAuthSection();
                    showToast("Session expired or invalid. Please log in again.", 'error');
                }
                return;
            }

            const userData = await response.json();

            // Check for admin role and show/hide admin button
            const userRoles = localStorage.getItem('roles') ? JSON.parse(localStorage.getItem('roles')) : [];
            if (userRoles.includes('ROLE_ADMIN')) {
                adminPanelButton.classList.remove('hidden');
                fabAdminButton.style.display = 'flex'; // Show FAB admin button
            } else {
                adminPanelButton.classList.add('hidden');
                fabAdminButton.style.display = 'none'; // Hide FAB admin button
            }

            // Disable/enable timeframe buttons based on premium/trial status
            const isPremium = userData.isPremium;
            const isTrialActive = userData.trialActive;

            // 15m, 30m, 1h, 1d are premium/trial features
            timeframe15mButton.disabled = !(isPremium || isTrialActive);
            timeframe30mButton.disabled = !(isPremium || isTrialActive);
            timeframe1hButton.disabled = !(isPremium || isTrialActive);
            timeframe1dButton.disabled = !(isPremium || isTrialActive);

            // If current timeframe is not allowed for non-premium/non-trial, switch to 4h
            if (!isPremium && !isTrialActive) {
                if (currentTimeframe !== '4h') {
                    setTimeframe('4h'); // This will also update localStorage and active button
                }
                showToast(`Welcome, ${userData.username}! Your trial has expired or you are not premium. Only 4H scans available.`, 'info');
            } else if (isTrialActive) {
                 showToast(`Welcome, ${userData.username}! Your trial expires on ${new Date(userData.trialExpiryDate).toLocaleDateString()}.`, 'info');
            } else if (isPremium) {
                 showToast(`Welcome, ${userData.username}! You have premium access.`, 'success');
            }


        } catch (error) {
            showToast("Error connecting to the service. Please try again.", 'error');
        }
    }


    async function handleAuthSubmit(event) {
        event.preventDefault();
        authSubmitButton.disabled = true;

        const username = usernameInput.value;
        const password = passwordInput.value;
        const email = emailInput.value;
        const plan = planSelect.value;

        let endpoint = `${API_BASE_URL}/auth/login`; // Default to login endpoint
        let body = { username, password };

        if (isAdminRegisterMode) {
            endpoint = `${API_BASE_URL}/auth/register-admin`;
            body = { username, password, email };
            if (!username || !password || !email) {
                showToast("Username, password, and email are required for admin registration.", 'error');
                authSubmitButton.disabled = false;
                return;
            }
        } else if (isRegisterMode) {
            endpoint = `${API_BASE_URL}/auth/register`;
            body.email = email;
            body.plan = plan;
            if (!username || !password || !email) {
                showToast("Username, password, and email are required for registration.", 'error');
                authSubmitButton.disabled = false;
                return;
            }
        } else {
            if (!username || !password) {
                showToast("Username and password are required for login.", 'error');
                authSubmitButton.disabled = false;
                return;
            }
        }

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            const data = await response.json();

            if (response.ok) {
                if (isAdminRegisterMode) {
                    showToast(data.message || "Admin registration successful! Please log in as admin.", 'success');
                    showAuthSection();
                } else if (isRegisterMode) {
                    showToast(data.message || "Registration successful!", 'success');
                    if (plan === 'premium') {
                        showPaymentSection(username);
                    } else {
                        localStorage.setItem('hasSeenOnboarding', 'false'); // Mark for onboarding
                        showAuthSection();
                        showToast("Registration successful! Please log in now.", 'info');
                    }
                } else {
                    showToast(data.message || "Login successful!", 'success');
                    if (data.token) {
                        localStorage.setItem('jwtToken', data.token);
                        localStorage.setItem('username', data.username);
                        localStorage.setItem('userId', data.id);
                        localStorage.setItem('roles', JSON.stringify(data.roles));
                        showScannerSection();
                    } else {
                        showToast("Login successful, but no token received. Please try again.", 'error');
                        showAuthSection(); // Fallback to auth section
                    }
                }

            } else {
                showToast(data.message || "An error occurred during authentication.", 'error');
            }
        } catch (error) {
            showToast(`Connection error. Please check your network connection and try again.`, 'error');
            console.error("Auth fetch error:", error);
        } finally {
            authSubmitButton.disabled = false;
        }
    }

    function toggleAuthFormMode() {
        isAdminRegisterMode = false;
        isRegisterMode = !isRegisterMode;
        if (isRegisterMode) {
            authFormTitle.textContent = 'Register';
            authSubmitButton.textContent = 'Register';
            emailGroup.classList.remove('hidden');
            planGroup.classList.remove('hidden');
            toggleAuthModeButton.textContent = "Already have an account? Login here.";
        } else {
            authFormTitle.textContent = 'Login';
            authSubmitButton.textContent = 'Login';
            emailGroup.classList.add('hidden');
            planGroup.classList.add('hidden');
            toggleAuthModeButton.textContent = "Don't have an account? Register here.";
        }
        usernameInput.value = '';
        passwordInput.value = '';
        emailInput.value = '';
    }

    function handleLogout() {
        showAuthSection();
        showToast("You have been logged out.", 'info');
    }

    // Payment Functions
    async function handleSubmitPaymentProof(event) {
        event.preventDefault();
        submitPaymentProofButton.disabled = true;

        const txHash = transactionHashInput.value;
        const userId = localStorage.getItem('pendingPaymentUsername');

        if (!txHash || !userId) {
            showToast("Transaction hash and user information are required.", 'error');
            submitPaymentProofButton.disabled = false;
            return;
        }

        const token = localStorage.getItem('jwtToken');
        if (!token) {
            showToast("Error: No authentication token found. Please log in first.", 'error');
            submitPaymentProofButton.disabled = false;
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/payment/submit-proof`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ transactionHash: txHash, userId: userId })
            });

            const data = await response.json();

            if (response.ok) {
                showToast(data.message || "Payment proof submitted successfully! Your premium access will be activated soon.", 'success');
                localStorage.removeItem('pendingPaymentUsername');
                setTimeout(() => {
                    showAuthSection();
                    showToast("Payment proof submitted. Please log in to check your status later.", 'info');
                }, 3000);
            } else {
                showToast(data.message || "Failed to submit payment proof. Please double-check the hash.", 'error');
            }
        } catch (error) {
            showToast(`Connection error. Please try again.`, 'error');
            console.error("Payment proof fetch error:", error);
        } finally {
            submitPaymentProofButton.disabled = false;
        }
    }

    // Initial check for admin button visibility on FAB
    function updateFabAdminButtonVisibility() {
        const userRoles = localStorage.getItem('roles') ? JSON.parse(localStorage.getItem('roles')) : [];
        const isLoggedIn = localStorage.getItem('jwtToken') !== null;

        if (isLoggedIn) {
            fabLogoutButton.style.display = 'flex';
            fabPaymentButton.style.display = 'flex';
            fabScanButton.style.display = 'flex';
            fabClearButton.style.display = 'flex';
        } else {
            fabLogoutButton.style.display = 'none';
            fabPaymentButton.style.display = 'none';
            fabScanButton.style.display = 'none';
            fabClearButton.style.display = 'none';
        }

        if (isLoggedIn && userRoles.includes('ROLE_ADMIN')) {
            adminPanelButton.classList.remove('hidden');
            fabAdminButton.style.display = 'flex';
        } else {
            adminPanelButton.classList.add('hidden');
            fabAdminButton.style.display = 'none';
        }
    }


    async function fetchOrderBlocks() {
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            showToast("Please log in to use the scanner.", 'error');
            showAuthSection();
            return;
        }

        scanButton.disabled = true;
        clearButton.disabled = true;
        document.querySelectorAll('.action-button[data-filter], .action-button[data-timeframe], .sensitivity-button').forEach(btn => btn.disabled = true);
        priceDeviationInput.disabled = true;
        fabScanButton.disabled = true;
        fabClearButton.disabled = true;


        spinner.classList.remove('hidden');
        buttonText.textContent = 'Scanning...';
        resultsContainer.innerHTML = skeletonCardHTML.repeat(6);

        const selectedPreset = sensitivityPresets[currentSensitivity];
        if (!selectedPreset) {
            showToast("Invalid sensitivity preset selected. Please choose a valid preset.", 'error');
            scanButton.disabled = false;
            clearButton.disabled = false;
            document.querySelectorAll('.action-button[data-filter], .action-button[data-timeframe], .sensitivity-button').forEach(btn => btn.disabled = false);
            priceDeviationInput.disabled = false;
            fabScanButton.disabled = false;
            fabClearButton.disabled = false;
            spinner.classList.add('hidden');
            buttonText.textContent = 'Initiate Scan';
            return;
        }

        const { minBodyRatio, minPriceChange, volumeFactor, requireBOS, requireC3ClosePastC2, requireFVG, minFvgDepthRatio } = selectedPreset;

        // Define the sequence of timeframes to try
        // The user's selected timeframe will be the first in the sequence
        const scanTimeframes = [currentTimeframe, '4h', '1h', '30m', '15m'].filter((value, index, self) => {
            // Ensure uniqueness and prioritize the selected timeframe if it's already in the sequence
            return self.indexOf(value) === index;
        });

        let foundResults = false;
        let actualTimeframeUsed = '';

        for (const tf of scanTimeframes) {
            showToast(`Attempting scan for ${tf.toUpperCase()} timeframe...`, 'info', 3000);
            try {
                const response = await fetch(`${API_BASE_URL}/scan-order-blocks?interval=${tf}&minBodyRatio=${minBodyRatio}&minPriceChange=${minPriceChange}&volumeFactor=${volumeFactor}&requireBOS=${requireBOS}&requireC3ClosePastC2=${requireC3ClosePastC2}&requireFVG=${requireFVG}&minFvgDepthRatio=${minFvgDepthRatio}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    let errorDetail = `Status: ${response.status} ${response.statusText || 'Unknown Error'}`;
                    try {
                        const errorBody = await response.json();
                        errorDetail = errorBody.message || JSON.stringify(errorBody);
                    } catch (bodyError) {
                        errorDetail += `. Could not read response body: ${bodyError.message}.`;
                    }
                    // Do not throw error immediately, try next timeframe
                    console.error(`Scan failed for ${tf}: ${errorDetail}`);
                    continue; // Try the next timeframe in the sequence
                }

                const data = await response.json();
                if (data && data.length > 0) {
                    allScanResults = data;
                    actualTimeframeUsed = tf;
                    foundResults = true;
                    break; // Stop scanning if results are found
                } else {
                    showToast(`No order blocks found for ${tf.toUpperCase()}. Trying next timeframe...`, 'info', 2000);
                }

            } catch (err) {
                console.error(`Network error during scan for ${tf}: ${err.message}`);
                showToast(`Network error for ${tf}: ${err.message}. Trying next timeframe...`, 'error', 2000);
                // Continue to the next timeframe if there's a network error for the current one
            }
        }

        if (foundResults) {
            filterResults(actualTimeframeUsed); // Pass the actual timeframe used for the toast
        } else {
            allScanResults = [];
            resultsContainer.innerHTML = '<p class="text-center text-color-red-accent col-span-full py-8">No order block data found across all tested timeframes. Please try adjusting parameters or scanning again later.</p>';
            showToast('No order block data found across all tested timeframes.', 'error');
        }

        scanButton.disabled = false;
        clearButton.disabled = false;
        document.querySelectorAll('.action-button[data-filter], .action-button[data-timeframe], .sensitivity-button').forEach(btn => btn.disabled = false);
        priceDeviationInput.disabled = false;
        fabScanButton.disabled = false;
        fabClearButton.disabled = false;
        spinner.classList.add('hidden');
        buttonText.textContent = 'Initiate Scan';
    }


    // --- Initial Setup Calls ---
    // Apply theme on load
    // For this theme, we force it to be dark
    applyTheme('dark');

    // Restore persisted states
    priceDeviationInput.value = maxPriceDeviationPercent;
    priceDeviationValueSpan.textContent = `${maxPriceDeviationPercent}%`; // Update display
    setTimeframe(currentTimeframe);
    setFilter(currentFilter);
    setSensitivity(currentSensitivity);
    updateSensitivityTooltips(); // Initialize tooltips


    // This is the CRITICAL part for initial visibility
    if (localStorage.getItem('jwtToken')) {
        showScannerSection();
    } else {
        showAuthSection();
    }


    // --- Event Listeners ---
    scanButton.addEventListener('click', fetchOrderBlocks);
    clearButton.addEventListener('click', clearResults);
    showAllButton.addEventListener('click', () => setFilter('All'));
    showBuyingButton.addEventListener('click', () => setFilter('Buying (Bullish)'));
    showSellingButton.addEventListener('click', () => setFilter('Selling (Bearish)'));
    // NEW Timeframe Button Listeners
    timeframe15mButton.addEventListener('click', () => setTimeframe('15m'));
    timeframe30mButton.addEventListener('click', () => setTimeframe('30m'));
    timeframe1hButton.addEventListener('click', () => setTimeframe('1h'));
    timeframe4hButton.addEventListener('click', () => setTimeframe('4h'));
    timeframe1dButton.addEventListener('click', () => setTimeframe('1d'));

    sensitivityButtons.forEach(button => {
      button.addEventListener('click', () => {
        setSensitivity(button.dataset.sensitivity);
      });
    });

    priceDeviationInput.addEventListener('input', (event) => { // Use 'input' for real-time update
        const newValue = parseFloat(event.target.value);
        if (!isNaN(newValue) && newValue >= 0 && newValue <= 100) {
            maxPriceDeviationPercent = newValue;
            localStorage.setItem('maxPriceDeviationPercent', newValue);
            priceDeviationValueSpan.textContent = `${newValue}%`; // Update the displayed value
            filterResults(); // Re-filter results as deviation changes
        } else {
            showToast("Please enter a valid percentage between 0 and 100.", 'error');
            event.target.value = maxPriceDeviationPercent; // Revert to last valid
            priceDeviationValueSpan.textContent = `${maxPriceDeviationPercent}%`;
        }
    });

    closeModalButton.addEventListener('click', () => closeModal(chartModal));
    paymentProofForm.addEventListener('submit', handleSubmitPaymentProof);

    // Admin Panel Event Listeners
    adminPanelButton.addEventListener('click', showAdminPanel);

    // Premium Welcome Modal Event Listeners
    closePremiumWelcomeModalButton.addEventListener('click', () => {
        if (dontShowPremiumAgainCheckbox.checked) {
            localStorage.setItem('hasSeenPremiumWelcome', 'true');
        }
        closeModal(premiumWelcomeModal);
    });
    closePremiumWelcomeModalX.addEventListener('click', () => {
        if (dontShowPremiumAgainCheckbox.checked) {
            localStorage.setItem('hasSeenPremiumWelcome', 'true');
        }
        closeModal(premiumWelcomeModal);
    });

    // Onboarding Modal Event Listeners
    closeOnboardingModalButton.addEventListener('click', finishOnboarding);
    onboardingPrevButton.addEventListener('click', prevOnboardingStep);
    onboardingNextButton.addEventListener('click', nextOnboardingStep);
    onboardingFinishButton.addEventListener('click', finishOnboarding);


    // Ripple effect for buttons (already present, ensured it works with new styling)
    document.querySelectorAll('.scan-button, .action-button, .fab-button').forEach(button => {
        button.addEventListener('click', function(e) {
            if (this.disabled) return;

            const ripple = document.createElement('span');
            ripple.classList.add('ripple');
            this.appendChild(ripple);

            const diameter = Math.max(this.clientWidth, this.clientHeight);
            const radius = diameter / 2;

            ripple.style.width = ripple.style.height = `${diameter}px`;
            ripple.style.left = `${e.clientX - this.getBoundingClientRect().left - radius}px`;
            ripple.style.top = `${e.clientY - this.getBoundingClientRect().top - radius}px`;

            ripple.addEventListener('animationend', () => {
                this.removeChild(ripple);
            });
        });
    });

    // FAB Toggle for mobile
    fabToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        fabMenu.classList.toggle('show');
        fabToggle.classList.toggle('rotate-45');
    });

    // FAB button actions
    fabScanButton.addEventListener('click', () => {
        fetchOrderBlocks();
        fabMenu.classList.remove('show');
        fabToggle.classList.remove('rotate-45');
    });
    fabClearButton.addEventListener('click', () => {
        clearResults();
        fabMenu.classList.remove('show');
        fabToggle.classList.remove('rotate-45');
    });
    fabAdminButton.addEventListener('click', () => {
        showAdminPanel();
        fabMenu.classList.remove('show');
        fabToggle.classList.remove('rotate-45');
    });
    fabPaymentButton.addEventListener('click', () => {
        openModal(paymentModal);
        fabMenu.classList.remove('show');
        fabToggle.classList.remove('rotate-45');
    });
    fabLogoutButton.addEventListener('click', () => {
        handleLogout();
        fabMenu.classList.remove('show');
        fabToggle.classList.remove('rotate-45');
    });


    // Close FAB menu if clicking outside
    document.addEventListener('click', (e) => {
        if (fabMenu.classList.contains('show') && !fabContainer.contains(e.target)) {
            fabMenu.classList.remove('show');
            fabToggle.classList.remove('rotate-45');
        }
    });
    fabMenu.addEventListener('click', (e) => {
        e.stopPropagation();
    });

    // Close modals on Escape key press
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (chartModal.classList.contains('show')) {
                closeModal(chartModal);
            } else if (paymentModal.classList.contains('show')) {
                closeModal(paymentModal);
            } else if (adminPanelModal.classList.contains('show')) {
                closeModal(adminPanelModal);
            } else if (premiumWelcomeModal.classList.contains('show')) {
                closeModal(premiumWelcomeModal);
            } else if (onboardingModal.classList.contains('show')) {
                closeModal(onboardingModal);
            }
        }
    });

    // Close modals on background click
    [chartModal, paymentModal, adminPanelModal, premiumWelcomeModal, onboardingModal].forEach(modal => {
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
    });

    // --- Authentication Event Listeners ---
    if (authForm) {
        authForm.addEventListener('submit', handleAuthSubmit);
    }

    if (toggleAuthModeButton) {
        toggleAuthModeButton.addEventListener('click', toggleAuthFormMode);
    }

    if (logoutButton) {
        logoutButton.addEventListener('click', handleLogout);
    }

    // Initial check for admin button visibility on FAB (called after all functions are defined)
    updateFabAdminButtonVisibility();

</script>
</body>
</html>
